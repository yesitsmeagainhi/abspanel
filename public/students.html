<!-- public/students.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Students CRUD</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-50 text-slate-800 font-sans">

  <!-- ─────────────────── NAVBAR ─────────────────── -->
  <nav class="bg-white shadow sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <span class="text-xl font-bold text-indigo-600">Dashboard</span>
        <div class="space-x-2 sm:space-x-4 text-sm font-medium">
          <a href="/"               class="hover:text-indigo-600">Home</a>
          <a href="lectures.html"   class="hover:text-indigo-600">Lectures</a>
          <a href="students.html"   class="text-indigo-600">Students</a>
          <a href="announcements.html" class="hover:text-indigo-600">Announcements</a>
          <a href="banners.html"    class="hover:text-indigo-600">Banners</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- ─────────────────── FORM ─────────────────── -->
    <section id="formSection" class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 id="formTitle" class="text-xl font-semibold mb-4">Add Student</h2>

      <form id="form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <input name="number"  placeholder="Phone Number"  required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" />
        <input name="password"placeholder="Password"     required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" />
        <input name="name"    placeholder="Name"          required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" />

        <select name="course" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500">
          <option value="">Select Course</option>
          <option value="D.Pharm">D.Pharm</option>
          <option value="B.Pharm">B.Pharm</option>
          <option value="GNM">GNM</option>
        </select>

        <select name="batch"  required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500">
          <option value="">Select Batch</option>
        </select>

        <select name="year"   required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500">
          <option value="">Select Year</option>
        </select>

        <select name="branch" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500">
          <option value="">Select Branch</option>
          <option>Nalasopara</option><option>Bhayandar</option><option>Malad</option>
          <option>Thane</option><option>Andheri</option><option>Kurla</option>
        </select>

        <input name="admissionYear" placeholder="Admission Year" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" />
        <input name="pendingFees"   placeholder="Pending Fees"   required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" />

        <select name="Role" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500">
          <option value="">Select Role</option>
          <option>Student</option><option>Faculty</option><option>Admin</option>
        </select>

        <input name="Faculty" placeholder="Faculty" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" />

        <div class="sm:col-span-2 lg:col-span-3 flex gap-2">
          <button type="submit" id="submitBtn"
                  class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700">
            Save
          </button>
          <button type="button" id="cancelBtn"
                  class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">
            Cancel
          </button>
        </div>
      </form>
    </section>

    <!-- ─────────────────── BULK IMPORT ─────────────────── -->
    <section class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">Bulk Import Students (Excel/CSV)</h2>
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <input type="file" id="bulkFile" accept=".csv, .xlsx, .xls"
               class="block w-full text-sm file:mr-4 file:py-2 file:px-4
                      file:rounded-md file:bg-green-50 file:text-green-700 hover:file:bg-green-100" />
        <button id="importBtn" class="px-4 py-2 bg-green-600 text-white rounded-md shadow hover:bg-green-700">
          Import
        </button>
      </div>
      <p class="text-sm text-slate-500 mt-2">
        Header row must contain: Phone, Name, Course, Batch, Year, Branch, Admission Year, Pending Fees, Role, Faculty, Password
      </p>
    </section>

    <!-- ─────────────────── TABLE ─────────────────── -->
    <section class="bg-white rounded-xl shadow overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-slate-100 text-slate-700 uppercase">
          <tr>
            <th class="px-4 py-3">Phone</th><th class="px-4 py-3">Name</th><th class="px-4 py-3">Course</th>
            <th class="px-4 py-3">Batch</th><th class="px-4 py-3">Year</th><th class="px-4 py-3">Branch</th>
            <th class="px-4 py-3">Admission&nbsp;Year</th><th class="px-4 py-3">Pending&nbsp;Fees</th>
            <th class="px-4 py-3">Role</th><th class="px-4 py-3">Faculty</th><th class="px-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody id="listBody" class="divide-y divide-slate-100"></tbody>
      </table>

      <div class="flex justify-between items-center px-4 py-3 bg-slate-100 text-sm" id="pager">
        <button id="prevBtn" class="px-3 py-1 bg-slate-200 rounded hover:bg-slate-300">Previous</button>
        <span id="pageInfo" class="text-slate-600"></span>
        <button id="nextBtn" class="px-3 py-1 bg-slate-200 rounded hover:bg-slate-300">Next</button>
      </div>
    </section>
  </main>

  <!-- ─────────────────── SCRIPT ─────────────────── -->
  <script>
  /* ---------- dropdown cascade ---------- */
  const dropdownMap = {
    'D.Pharm': { years:['1st Year','2nd Year'],      batches:['D- Batch D.Pharm','E- Batch D.Pharm','F- Batch D.Pharm'] },
    'B.Pharm': { years:['sem 1','sem 2','sem 3','sem 4','sem 5','sem 6','sem 7','sem 8'],
                 batches:['24-25 B.Pharm','25-26 B.Pharm'] },
    'GNM':     { years:['1st Year','2nd Year','3rd Year'], batches:['E- Batch Gnm','F- Batch Gnm'] }
  };
  const courseSel = document.querySelector('select[name="course"]');
  const batchSel  = document.querySelector('select[name="batch"]');
  const yearSel   = document.querySelector('select[name="year"]');

  courseSel.addEventListener('change', () => {
    const cfg = dropdownMap[courseSel.value] || { years:[], batches:[] };
    batchSel.innerHTML = '<option value="">Select Batch</option>' +
      cfg.batches.map(v=>`<option>${v}</option>`).join('');
    yearSel.innerHTML  = '<option value="">Select Year</option>' +
      cfg.years.map(v=>`<option>${v}</option>`).join('');
  });

  /* ---------- pagination & state ---------- */
  const perPage = 30;
  let currentPage = 1;
  let totalCount  = 0;

  const cursors   = [null]; // startAfterId for each page (index = page-1)
  let students    = [];     // docs of current page

  /* ---------- helpers ---------- */
  const qs = p => document.querySelector(p);
  const render = () => {
    const rows = students.map( (s,i) => `
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3">${s.number}</td>
        <td class="px-4 py-3">${s.name}</td>
        <td class="px-4 py-3">${s.course}</td>
        <td class="px-4 py-3">${s.batch}</td>
        <td class="px-4 py-3">${s.year}</td>
        <td class="px-4 py-3">${s.branch}</td>
        <td class="px-4 py-3">${s.admissionYear}</td>
        <td class="px-4 py-3">₹${s.pendingFees}</td>
        <td class="px-4 py-3">${s.Role}</td>
        <td class="px-4 py-3">${s.Faculty}</td>
        <td class="px-4 py-3">
          <div class="flex space-x-2">
            <button onclick="editStudent(${i})"
                    class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Edit</button>
            <button onclick="deleteStudent('${s.id}',${i})"
                    class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">Delete</button>
          </div>
        </td>
      </tr>`).join('');
    qs('#listBody').innerHTML = rows || `<tr><td colspan="11" class="text-center py-8 text-slate-500">No data</td></tr>`;

    const pages = Math.max(1, Math.ceil(totalCount / perPage));
    qs('#pageInfo').textContent = `Page ${currentPage} of ${pages}`;
    qs('#prevBtn').disabled = currentPage === 1;
    qs('#nextBtn').disabled = currentPage >= pages;
  };

  const buildUrl = () => {
    const params = new URLSearchParams({ limit: perPage });
    const cursor = cursors[currentPage-1];
    if (cursor) params.append('startAfterId', cursor);
    return '/api/students?' + params.toString();
  };

  const loadPage = async () => {
    const res  = await fetch(buildUrl());
    const data = await res.json();

    students   = data.students || [];
    totalCount = data.totalStudents ?? totalCount;          // total only on first page
    if (data.lastVisible) cursors[currentPage] = data.lastVisible;
    render();
  };

  /* ---------- table actions ---------- */
  window.editStudent = (idx) => {
    const stu = students[idx];
    const f   = qs('#form');
    Object.entries(stu).forEach(([k,v]) => { if (f[k]) f[k].value = v; });
    courseSel.dispatchEvent(new Event('change'));           // cascade dropdowns
    qs('#formTitle').textContent = 'Edit Student';
    qs('#submitBtn').textContent = 'Update';
    f.dataset.editId = stu.id;
    f.scrollIntoView({ behavior:'smooth' });
  };

  window.deleteStudent = async (id, idx) => {
    if (!confirm('Delete student?')) return;
    await fetch(`/api/students/${id}`, { method:'DELETE' });
    students.splice(idx,1);
    totalCount--;
    render();
  };

  /* ---------- form submit ---------- */
  qs('#form').addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    const editId = e.target.dataset.editId;

    const method = editId ? 'PUT' : 'POST';
    const url    = editId ? `/api/students/${editId}` : '/api/students';

    const res = await fetch(url, {
      method,
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    if (!res.ok) return alert('Save failed');

    if (editId) {
      // update in-place
      const idx = students.findIndex(s=>s.id===editId);
      if (idx>-1) students[idx] = { id:editId, ...data };
    } else {
      const { id } = await res.json();
      if (currentPage === 1) students.unshift({ id, ...data });   // show instantly
      totalCount++;
    }
    resetForm();
    render();
  });

  const resetForm = () => {
    qs('#form').reset();
    delete qs('#form').dataset.editId;
    qs('#formTitle').textContent = 'Add Student';
    qs('#submitBtn').textContent = 'Save';
    batchSel.innerHTML = '<option value="">Select Batch</option>';
    yearSel.innerHTML  = '<option value="">Select Year</option>';
  };
  qs('#cancelBtn').onclick = resetForm;

  /* ---------- pagination buttons ---------- */
  qs('#prevBtn').onclick = () => { if (currentPage>1){ currentPage--; loadPage(); } };
  qs('#nextBtn').onclick = () => {
    const pages = Math.ceil(totalCount / perPage);
    if (currentPage < pages){ currentPage++; loadPage(); }
  };

  /* ---------- bulk import ---------- */
  const headerMap = { phone:'number', name:'name', course:'course', batch:'batch',
                      year:'year', branch:'branch', 'admission year':'admissionYear',
                      'pending fees':'pendingFees', role:'Role', faculty:'Faculty', password:'password' };

  qs('#importBtn').onclick = () => {
    const file = qs('#bulkFile').files[0];
    if (!file) return alert('Choose a file');
    const reader = new FileReader();
    reader.onload = async e => {
      const wb   = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws   = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {header:1,raw:false});
      const headers = rows[0].map(h=>String(h||'').toLowerCase());
      const valid = [];
      rows.slice(1).forEach(r=>{
        const obj={}; headers.forEach((h,i)=>{ if(headerMap[h]) obj[headerMap[h]]=r[i]; });
        if (obj.number && obj.name && obj.course) valid.push(obj);
      });
      let ok=0, fail=0;
      for (const s of valid){
        const resp = await fetch('/api/students',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(s)});
        resp.ok ? ok++ : fail++;
      }
      alert(`Imported ${ok} students${fail?' — '+fail+' failed':''}`);
      if (currentPage===1) loadPage();   // refresh first page view
    };
    reader.readAsArrayBuffer(file);
  };

  /* ---------- kick-off ---------- */
  loadPage();
  </script>
</body>
</html>
