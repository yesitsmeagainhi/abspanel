<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lectures CRUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <nav class="bg-white shadow sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <span class="text-xl font-bold text-indigo-600">Dashboard</span>
                <div class="space-x-2 sm:space-x-4 text-sm font-medium">
                    <a href="/"            class="hover:text-indigo-600 transition">Home</a>
                    <a href="lectures.html"  class="text-indigo-600">Lectures</a>
                    <a href="students.html"  class="hover:text-indigo-600 transition">Students</a>
                    <a href="announcements.html" class="hover:text-indigo-600 transition">Announcements</a>
                    <a href="banners.html" class="hover:text-indigo-600 transition">Banners</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section id="formSection" class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 id="formTitle" class="text-xl font-semibold mb-4">Add Lecture</h2>
            <form id="form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <select name="course" id="courseSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Course</option>
                    <option value="D.Pharm">D.Pharm</option>
                    <option value="B.Pharm">B.Pharm</option>
                    <option value="GNM">GNM</option>
                </select>
                
                <select name="batch" id="batchSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Batch</option>
                </select>
                
                <select name="branch" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Branch</option>
                    <option value="Nalasopara">Nalasopara</option>
                    <option value="Bhayandar">Bhayandar</option>
                    <option value="Malad">Malad</option>
                    <option value="Thane">Thane</option>
                    <option value="Andheri">Andheri</option>
                    <option value="Kurla">Kurla</option>
                </select>
                
                <select name="year" id="yearSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Year/Semester</option>
                </select>
                
                <select name="subject" id="subjectSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Subject</option>
                </select>
                
                <select name="faculty" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Faculty</option>
                    <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
                    <option value="Rubina Khan mam">Rubina Khan mam</option>
                    <option value="Abhishekh Prajapati Sir">Abhishekh Prajapati Sir</option>
                    <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
                    <option value="Akashdeep Udmale Sir">Akashdeep Udmale Sir</option>
                    <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
                    <option value="Priya Vijay Gholap mam">Priya Vijay Gholap mam</option>
                    <option value="Amit Agrawal sir">Amit Agrawal sir</option>
                    <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
                    <option value="Deepika Gill mam">Deepika Gill mam</option>
                    <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
                    <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
                    <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
                    <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
                    <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
                    <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
                    <option value="Rajesh sir">Rajesh sir</option>
                    <option value="Ravish Sir">Ravish Sir</option>
                    <option value="ajay">ajay</option>
                    <option value="Naresh Basude">Naresh Basude</option>
                    <option value="Zara Mam">Zara Mam</option>
                    <option value="Suryansh Sir">Suryansh Sir</option>
                    <option value="Sneha durge mam">Sneha durge mam</option>
                    <option value="Dr Utpala mam">Dr Utpala mam</option>
                </select>
                
                <input  name="date"      type="date"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="start"     type="time"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="end"       type="time"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                
                <select name="mode" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Mode</option>
                    <option value="Online">Online</option>
                    <option value="Offline">Offline</option>
                </select>
                
                <input  name="link"      placeholder="Link (opt)"          class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="location"  placeholder="Location (opt)"    class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">

                <div class="sm:col-span-2 lg:col-span-3 flex gap-2">
                    <button type="submit" id="submitBtn"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition">
                        Save
                    </button>
                    <button type="button" id="cancelBtn"
                            class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Filter Lectures</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <select id="dateFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Dates</option>
                    <option value="today">Today's Lectures</option>
                    <option value="previous">Previous Lectures</option>
                    <option value="upcoming">Upcoming Lectures</option>
                </select>
                <select id="courseFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Courses</option>
                    <option value="D.Pharm">D.Pharm</option>
                    <option value="B.Pharm">B.Pharm</option>
                    <option value="GNM">GNM</option>
                </select>
                <select id="facultyFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Faculty</option>
                    <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
                    <option value="Rubina Khan mam">Rubina Khan mam</option>
                    <option value="Abhishekh Prajapati Sir">Abhishekh Prajapati Sir</option>
                    <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
                    <option value="Akashdeep Udmale Sir">Akashdeep Udmale Sir</option>
                    <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
                    <option value="Priya Vijay Gholap mam">Priya Vijay Gholap mam</option>
                    <option value="Amit Agrawal sir">Amit Agrawal sir</option>
                    <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
                    <option value="Deepika Gill mam">Deepika Gill mam</option>
                    <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
                    <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
                    <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
                    <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
                    <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
                    <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
                    <option value="Rajesh sir">Rajesh sir</option>
                    <option value="Ravish Sir">Ravish Sir</option>
                    <option value="ajay">ajay</option>
                    <option value="Naresh Basude">Naresh Basude</option>
                    <option value="Zara Mam">Zara Mam</option>
                    <option value="Suryansh Sir">Suryansh Sir</option>
                    <option value="Sneha durge mam">Sneha durge mam</option>
                    <option value="Dr Utpala mam">Dr Utpala mam</option>
                </select>
                <select id="modeFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Modes</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                </select>
            </div>
            <div class="mt-4 flex flex-wrap gap-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    Today's Lectures
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                    <div class="w-2 h-2 bg-orange-500 rounded-full mr-2"></div>
                    Upcoming Lectures
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                    Previous Lectures
                </span>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow overflow-x-auto">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Lectures</h3>
                    <div class="flex gap-2">
                        <button id="loadMoreBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition" style="display: none;">Load More</button>
                        <span id="loadingIndicator" class="text-sm text-gray-500" style="display: none;">Loading...</span>
                    </div>
                </div>
            </div>
            <table id="list" class="w-full text-sm text-left">
                <thead class="bg-slate-100 text-slate-700 uppercase tracking-wider">
                    <tr>
                        <th class="px-4 py-3">Course</th><th class="px-4 py-3">Batch</th><th class="px-4 py-3">Branch</th>
                        <th class="px-4 py-3">Year</th><th class="px-4 py-3">Subject</th><th class="px-4 py-3">Faculty</th>
                        <th class="px-4 py-3">Date</th><th class="px-4 py-3">Start</th><th class="px-4 py-3">End</th>
                        <th class="px-4 py-3">Mode</th><th class="px-4 py-3">Link</th><th class="px-4 py-3">Location</th>
                        <th class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100" id="listBody">
                </tbody>
            </table>
        </section>
    </main>

<script>
/* ──────────────────────────────────────────────────────────
   DOM references
   ────────────────────────────────────────────────────────── */
const form         = document.getElementById('form');
const formTitle    = document.getElementById('formTitle');
const submitBtn    = document.getElementById('submitBtn');
const cancelBtn    = document.getElementById('cancelBtn');

const loadMoreBtn  = document.getElementById('loadMoreBtn');   // kept, but auto-hidden
const spinner      = document.getElementById('loadingIndicator');

const dateFilter   = document.getElementById('dateFilter');
const courseFilter = document.getElementById('courseFilter');
const facultyFilter= document.getElementById('facultyFilter');
const modeFilter   = document.getElementById('modeFilter');

const courseSel    = document.getElementById('courseSelect');
const batchSel     = document.getElementById('batchSelect');
const yearSel      = document.getElementById('yearSelect');
const subjectSel   = document.getElementById('subjectSelect');
const tbody        = document.getElementById('listBody');

/* ──────────────────────────────────────────────────────────
   Local state
   ────────────────────────────────────────────────────────── */
let editId        = null;
let lectures      = [];        // all rows currently shown
let cursor        = null;      // Firestore startAfterId
let hasMore       = false;
let isLoading     = false;
const PER_PAGE    = 30;        // matches server default

/* ──────────────────────────────────────────────────────────
   Dropdown cascade data
   ────────────────────────────────────────────────────────── */
const DD = {
  batches : {
    'D.Pharm':['D- Batch D.Pharm','E- Batch D.Pharm','F- Batch D.Pharm'],
    'B.Pharm':['24-25 B.Pharm','25-26 B.Pharm'],
    'GNM'    :['E- Batch Gnm','F- Batch Gnm']
  },
  years : {
    'D.Pharm':['1st Year','2nd Year'],
    'B.Pharm':['sem 1','sem 2','sem 3','sem 4','sem 5','sem 6','sem 7','sem 8'],
    'GNM'    :['1st Year','2nd Year','3rd Year']
  },
  subjects : {
    /*  <<< keep your full subject map here – truncated for brevity >>> */
    'D.Pharm':{ /* … */ }, 'B.Pharm':{ /* … */ }, 'GNM':{ /* … */ }
  }
};

/* ──────────────────────────────────────────────────────────
   Cascading dropdown helpers
   ────────────────────────────────────────────────────────── */
const fill = (sel, list, ph='Select')=>{
  sel.innerHTML = `<option value="">${ph}</option>` + list.map(o=>`<option>${o}</option>`).join('');
  sel.disabled  = !list.length;
};
const reset = (sel, ph)=>fill(sel,[],ph);

courseSel.onchange = ()=>{
  const c = courseSel.value;
  fill(batchSel , DD.batches[c]||[], 'Select Batch');
  fill(yearSel  , DD.years[c]  ||[], 'Select Year/Semester');
  reset(subjectSel,'Select Subject');
};
yearSel.onchange = ()=>{
  const list = DD.subjects[courseSel.value]?.[yearSel.value] || [];
  fill(subjectSel,list,'Select Subject');
};

/* ──────────────────────────────────────────────────────────
   Utility helpers
   ────────────────────────────────────────────────────────── */
const todayISO = () => new Date().toISOString().split('T')[0];

const rowClass = d =>
  d === todayISO() ? 'bg-green-50 border-l-4 border-green-500'
: d  > todayISO() ? 'bg-orange-50 border-l-4 border-orange-500'
                  : 'bg-gray-50  border-l-4 border-gray-400';

/*  Group order: today → future → past,
    then sort future ascending, past descending                */
function sortLects(arr){
  const t = todayISO();
  return arr.slice().sort((a,b)=>{
    if (a.date === t && b.date !== t) return -1;
    if (b.date === t && a.date !== t) return  1;

    if (a.date > t && b.date > t)   return new Date(a.date) - new Date(b.date); // upcoming asc
    if (a.date < t && b.date < t)   return new Date(b.date) - new Date(a.date); // previous desc

    return a.date > t ? -1 : 1;  // upcoming before previous
  });
}

/* ──────────────────────────────────────────────────────────
   Build API-query URL
   ────────────────────────────────────────────────────────── */
function buildUrl(){
  const p = new URLSearchParams({ limit: PER_PAGE });
  if (cursor) p.append('startAfterId', cursor);

  if (dateFilter.value   !== 'all') p.append('dateFilter', dateFilter.value);
  if (courseFilter.value !== 'all') p.append('course',     courseFilter.value);
  if (facultyFilter.value!== 'all') p.append('faculty',    facultyFilter.value);
  if (modeFilter.value   !== 'all') p.append('mode',       modeFilter.value);

  return '/api/lectures?' + p.toString();
}

/* ──────────────────────────────────────────────────────────
   Data loader – pulls *all* pages so everything is shown
   on first render.  One extra read per additional page.
   ────────────────────────────────────────────────────────── */
async function fetchAllLectures(){
  isLoading = true; spinner.style.display = 'inline';
  lectures  = []; cursor = null; hasMore = true;

  while (hasMore){                 // loop through pages
    const res = await fetch(buildUrl());
    if (!res.ok){ console.error(await res.text()); break; }

    const { lectures:rows = [], lastVisible, hasMore:more } = await res.json();
    lectures.push(...rows);
    cursor  = lastVisible;
    hasMore = more;
    if (!hasMore) break;           // stop when server says no more
  }

  isLoading = false; spinner.style.display = 'none';
  render();
}

/* ──────────────────────────────────────────────────────────
   Rendering
   ────────────────────────────────────────────────────────── */
function render(){
  const html = sortLects(lectures).map(l=>`
    <tr class="hover:bg-slate-50 ${rowClass(l.date)}">
      <td class="px-4 py-3">${l.course}</td>
      <td class="px-4 py-3">${l.batch}</td>
      <td class="px-4 py-3">${l.branch||''}</td>
      <td class="px-4 py-3">${l.year}</td>
      <td class="px-4 py-3">${l.subject}</td>
      <td class="px-4 py-3">${l.faculty}</td>
      <td class="px-4 py-3">
        <span class="font-medium">${l.date}</span>
        ${l.date===todayISO()?'<span class="ml-1 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">Today</span>':''}
      </td>
      <td class="px-4 py-3">${l.start}</td>
      <td class="px-4 py-3">${l.end}</td>
      <td class="px-4 py-3">
        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${String(l.mode).toLowerCase()==='online'?'bg-blue-100 text-blue-800':'bg-purple-100 text-purple-800'}">
          ${l.mode||'N/A'}
        </span>
      </td>
      <td class="px-4 py-3">${l.link?`<a href="${l.link}" target="_blank" class="text-indigo-600">🔗</a>`:''}</td>
      <td class="px-4 py-3">${l.location||''}</td>
      <td class="px-4 py-3">
        <button onclick="editLecture('${l.id}')"   class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Edit</button>
        <button onclick="deleteLecture('${l.id}')" class="px-3 py-1 bg-red-500  text-white text-xs rounded hover:bg-red-600">Delete</button>
      </td>
    </tr>`).join('');

  tbody.innerHTML = html || `<tr><td colspan="13" class="py-8 text-center text-slate-500">No data</td></tr>`;
  loadMoreBtn.style.display = 'none';   // all rows already fetched
}

/* ──────────────────────────────────────────────────────────
   CRUD helpers
   ────────────────────────────────────────────────────────── */
window.deleteLecture = async id=>{
  if (!confirm('Delete lecture?')) return;
  await fetch(`/api/lectures/${id}`,{method:'DELETE'});
  lectures = lectures.filter(l=>l.id!==id);
  render();
};

window.editLecture = async id=>{
  const r = await fetch(`/api/lectures/${id}`);
  if(!r.ok) return alert('Lecture not found');
  const lec = await r.json();

  courseSel.value = lec.course||''; courseSel.dispatchEvent(new Event('change'));
  setTimeout(()=>{
    batchSel.value = lec.batch||'';
    yearSel.value  = lec.year ||''; yearSel.dispatchEvent(new Event('change'));
    setTimeout(()=>{ subjectSel.value = lec.subject||''; },20);
  },20);

  ['branch','date','start','end','mode','link','location','faculty']
    .forEach(f=> form[f] && (form[f].value = lec[f]||''));

  editId = id;
  formTitle.textContent = 'Edit Lecture';
  submitBtn.textContent = 'Update';
  form.scrollIntoView({behavior:'smooth'});
};

form.addEventListener('submit',async e=>{
  e.preventDefault();
  const body = JSON.stringify(Object.fromEntries(new FormData(form)));
  const url  = editId ? `/api/lectures/${editId}` : '/api/lectures';
  const res  = await fetch(url,{method: editId?'PUT':'POST',
                                headers:{'Content-Type':'application/json'}, body});
  if(!res.ok) return alert('Save failed');

  resetForm(); fetchAllLectures();
});

function resetForm(){
  form.reset(); editId=null;
  formTitle.textContent='Add Lecture'; submitBtn.textContent='Save';
  reset(batchSel ,'Select Batch');
  reset(yearSel  ,'Select Year/Semester');
  reset(subjectSel,'Select Subject');
}
cancelBtn.onclick = resetForm;

/* ──────────────────────────────────────────────────────────
   Filter handling  (every change → reload entire list)
   ────────────────────────────────────────────────────────── */
[dateFilter,courseFilter,facultyFilter,modeFilter].forEach(sel=>{
  sel.onchange = fetchAllLectures;
});

/* ──────────────────────────────────────────────────────────
   Kick-off
   ────────────────────────────────────────────────────────── */
fetchAllLectures();
</script>

</body>
</html>