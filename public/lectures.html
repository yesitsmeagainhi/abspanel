<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lectures CRUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <nav class="bg-white shadow sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <span class="text-xl font-bold text-indigo-600">Dashboard</span>
                <div class="space-x-2 sm:space-x-4 text-sm font-medium">
                    <a href="/"            class="hover:text-indigo-600 transition">Home</a>
                    <a href="lectures.html"  class="text-indigo-600">Lectures</a>
                    <a href="students.html"  class="hover:text-indigo-600 transition">Students</a>
                    <a href="announcements.html" class="hover:text-indigo-600 transition">Announcements</a>
                    <a href="banners.html" class="hover:text-indigo-600 transition">Banners</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section id="formSection" class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 id="formTitle" class="text-xl font-semibold mb-4">Add Lecture</h2>
            
            <!-- Holiday Checkbox -->
            <div class="mb-6 flex items-center gap-2">
                <input type="checkbox" id="holidayCheckbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="holidayCheckbox" class="text-sm text-slate-700">Mark as Holiday</label>
            </div>
            
            <form id="form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <select name="course" id="courseSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Course</option>
                    <option value="D.Pharm">D.Pharm</option>
                    <option value="B.Pharm">B.Pharm</option>
                    <option value="GNM">GNM</option>
                </select>
                
                <select name="batch" id="batchSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Batch</option>
                </select>
                
                <select name="branch" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Branch</option>
                    <option value="Nalasopara">Nalasopara</option>
                    <option value="Bhayandar">Bhayandar</option>
                    <option value="Malad">Malad</option>
                    <option value="Thane">Thane</option>
                    <option value="Andheri">Andheri</option>
                    <option value="Kurla">Kurla</option>
                </select>
                
                <select name="year" id="yearSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Year/Semester</option>
                </select>
                
                <select name="subject" id="subjectSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Subject</option>
                </select>
                
                <select name="faculty" id="facultySelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Faculty</option>
                    <option value="-">-</option>
                    <option value="ajay">ajay</option>
                    <option value="Amit Agrawal sir">Amit Agrawal sir</option>
                    <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
                    <option value="Deepika Gill mam">Deepika Gill mam</option>
                    <option value="Dr. Akashdeep Udmale Sir">Dr. Akashdeep Udmale Sir</option>
                    <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
                    <option value="Dr. Snehal Chavhan mam">Dr. Snehal Chavhan mam</option>
                    <option value="Dr Utpala mam">Dr Utpala mam</option>
                    <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
                    <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
                    <option value="Mr. Abhishek prajapati">Mr. Abhishek prajapati</option>
                    <option value="Naresh Basude">Naresh Basude</option>
                    <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
                    <option value="Priya mayur dighe mam">Priya mayur dighe mam</option>
                    <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
                    <option value="Rajesh Prajapat">Rajesh Prajapat</option>
                    <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
                    <option value="Ravish Verma Sir">Ravish Verma Sir</option>
                    <option value="Rubina Khan mam">Rubina Khan mam</option>
                    <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
                    <option value="Sharda Burande mam">Sharda Burande mam</option>
                    <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
                    <option value="Sneha durge mam">Sneha durge mam</option>
                    <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
                    <option value="Suryansh Singh">Suryansh Singh</option>
                    <option value="Zara Mam">Zara Mam</option>
                    <option value="Poonam Yadav mam">Poonam Yadav mam</option>
                </select>
                
                <input  name="date" id="dateInput" type="date" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="start" id="startInput" type="time" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="end" id="endInput" type="time" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                
                <select name="mode" id="modeSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Mode</option>
                    <option value="Lecture">Lecture</option>
                    <option value="Test">Test</option>
                    <option value="No Lecture">No Lecture</option>
                </select>
                
                <input  name="link"      placeholder="Link (opt)"          class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="location"  placeholder="Location (opt)"    class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">

                <div class="sm:col-span-2 lg:col-span-3 flex gap-2">
                    <button type="submit" id="submitBtn"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition">
                        Save
                    </button>
                    <button type="button" id="cancelBtn"
                            class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white rounded-xl shadow p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                <h2 class="text-xl font-semibold">Filter Lectures</h2>
                <div class="flex gap-2 items-center flex-wrap">
                    <button id="downloadBtn" class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download CSV
                    </button>
                    <button id="clearFiltersBtn" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition">
                        Clear All
                    </button>
                    <span id="resultCount" class="text-sm text-gray-600 font-medium"></span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 mb-4">
                <div>
                    <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <select id="dateFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Dates</option>
                        <option value="today">Today's Lectures</option>
                        <option value="tomorrow">Tomorrow's Lectures</option>
                        <option value="previous">Previous Lectures</option>
                        <option value="upcoming">Upcoming Lectures</option>
                        <option value="this_week">This Week</option>
                        <option value="next_week">Next Week</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <div id="customDateRangeDiv" style="display: none;">
                    <label for="customDateRange" class="block text-sm font-medium text-gray-700 mb-1">Select Date Range</label>
                    <input type="text" id="customDateRange" placeholder="Select date range" readonly
                           class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer bg-white">
                </div>
                
                <div>
                    <label for="courseFilter" class="block text-sm font-medium text-gray-700 mb-1">Course</label>
                    <select id="courseFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Courses</option>
                        <option value="D.Pharm">D.Pharm</option>
                        <option value="B.Pharm">B.Pharm</option>
                        <option value="GNM">GNM</option>
                    </select>
                </div>
                
                <div>
                    <label for="branchFilter" class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
                    <select id="branchFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Branches</option>
                        <option value="Nalasopara">Nalasopara</option>
                        <option value="Bhayandar">Bhayandar</option>
                        <option value="Malad">Malad</option>
                        <option value="Thane">Thane</option>
                        <option value="Andheri">Andheri</option>
                        <option value="Kurla">Kurla</option>
                    </select>
                </div>
                
               <div>
    <label for="facultyFilter" class="block text-sm font-medium text-gray-700 mb-1">Faculty</label>
    <select id="facultyFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
        <option value="all">All Faculty</option>
        <option value="-">-</option>
        <option value="ajay">ajay</option>
        <option value="Amit Agrawal sir">Amit Agrawal sir</option>
        <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
        <option value="Deepika Gill mam">Deepika Gill mam</option>
        <option value="Dr. Akashdeep Udmale Sir">Dr. Akashdeep Udmale Sir</option>
        <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
        <option value="Dr. Snehal Chavhan mam">Dr. Snehal Chavhan mam</option>
        <option value="Dr Utpala mam">Dr Utpala mam</option>
        <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
        <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
        <option value="Mr. Abhishek prajapati">Mr. Abhishek prajapati</option>
        <option value="Naresh Basude">Naresh Basude</option>
        <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
        <option value="Priya mayur dighe mam">Priya mayur dighe mam</option>
        <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
        <option value="Rajesh Prajapat">Rajesh Prajapat</option>
        <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
        <option value="Ravish Verma Sir">Ravish Verma Sir</option>
        <option value="Rubina Khan mam">Rubina Khan mam</option>
        <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
        <option value="Sharda Burande mam">Sharda Burande mam</option>
        <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
        <option value="Sneha durge mam">Sneha durge mam</option>
        <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
        <option value="Suryansh Singh">Suryansh Singh</option>
        <option value="Zara Mam">Zara Mam</option>
        <option value="Poonam Yadav mam">Poonam Yadav mam</option>
    </select>
</div>
                
                <div>
                    <label for="modeFilter" class="block text-sm font-medium text-gray-700 mb-1">Mode</label>
                    <select id="modeFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Modes</option>
                        <option value="Lecture">Lecture</option>
                        <option value="Test">Test</option>
                        <option value="No Lecture">No Lecture</option>
                    </select>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div id="activeFilters" class="mb-4" style="display: none;">
                <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-sm font-medium text-gray-700">Active filters:</span>
                    <div id="filterTags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    Today's Lectures
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                    Tomorrow's Lectures
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                    <div class="w-2 h-2 bg-orange-500 rounded-full mr-2"></div>
                    Upcoming Lectures  
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                    Previous Lectures
                </span>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow overflow-x-auto">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Lectures</h3>
                    <div class="flex gap-2 items-center">
                        <span id="loadingIndicator" class="text-sm text-gray-500" style="display: none;">Loading...</span>
                    </div>
                </div>
            </div>
            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="px-4 py-3 bg-blue-50 border-b border-blue-200 flex items-center justify-between" style="display: none;">
                <div class="flex items-center gap-4">
                    <span id="selectedCount" class="text-sm font-medium text-blue-800">0 lectures selected</span>
                    <button id="selectAllBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">Select All on Page</button>
                    <button id="clearSelectionBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">Clear Selection</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="bulkDeleteBtn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Delete Selected
                    </button>
                </div>
            </div>

            <table id="list" class="w-full text-sm text-left">
                <thead class="bg-slate-100 text-slate-700 uppercase tracking-wider">
                    <tr>
                        <th class="px-4 py-3 w-12">
                            <input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        </th>
                        <th class="px-4 py-3">Course</th><th class="px-4 py-3">Batch</th><th class="px-4 py-3">Branch</th>
                        <th class="px-4 py-3">Year</th><th class="px-4 py-3">Subject</th><th class="px-4 py-3">Faculty</th>
                        <th class="px-4 py-3">Date</th><th class="px-4 py-3">Start</th><th class="px-4 py-3">End</th>
                        <th class="px-4 py-3">Mode</th><th class="px-4 py-3">Link</th><th class="px-4 py-3">Location</th>
                        <th class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100" id="listBody">
                </tbody>
            </table>
            
            <!-- Pagination Controls -->
            <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 sm:px-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center text-sm text-gray-700">
                        <span id="paginationInfo">Showing 1 to 50 of 100 results</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="firstPageBtn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            First
                        </button>
                        <button id="prevPageBtn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Previous
                        </button>
                        
                        <div id="pageNumbers" class="flex items-center space-x-1">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        
                        <button id="nextPageBtn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                        <button id="lastPageBtn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Last
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

<script>
/* ──────────────────────────────────────────────────────────
   DOM references
   ────────────────────────────────────────────────────────── */
const form         = document.getElementById('form');
const formTitle    = document.getElementById('formTitle');
const submitBtn    = document.getElementById('submitBtn');
const cancelBtn    = document.getElementById('cancelBtn');

const spinner      = document.getElementById('loadingIndicator');

const dateFilter   = document.getElementById('dateFilter');
const courseFilter = document.getElementById('courseFilter');
const branchFilter = document.getElementById('branchFilter');
const facultyFilter= document.getElementById('facultyFilter');
const modeFilter   = document.getElementById('modeFilter');
const clearFiltersBtn = document.getElementById('clearFiltersBtn');
const downloadBtn  = document.getElementById('downloadBtn');
const resultCount  = document.getElementById('resultCount');
const activeFilters = document.getElementById('activeFilters');
const filterTags   = document.getElementById('filterTags');
const customDateRange = document.getElementById('customDateRange');
const customDateRangeDiv = document.getElementById('customDateRangeDiv');

const courseSel    = document.getElementById('courseSelect');
const batchSel     = document.getElementById('batchSelect');
const yearSel      = document.getElementById('yearSelect');
const subjectSel   = document.getElementById('subjectSelect');
const facultySel   = document.getElementById('facultySelect');
const startInput   = document.getElementById('startInput');
const endInput     = document.getElementById('endInput');
const modeSelect   = document.getElementById('modeSelect');
const holidayCheckbox = document.getElementById('holidayCheckbox');
const tbody        = document.getElementById('listBody');

// Pagination controls
const paginationInfo = document.getElementById('paginationInfo');
const firstPageBtn = document.getElementById('firstPageBtn');
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');
const lastPageBtn = document.getElementById('lastPageBtn');
// Bulk actions elements
const bulkActionsBar = document.getElementById('bulkActionsBar');
const selectedCount = document.getElementById('selectedCount');
const selectAllBtn = document.getElementById('selectAllBtn');
const clearSelectionBtn = document.getElementById('clearSelectionBtn');
const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
const selectAllCheckbox = document.getElementById('selectAllCheckbox');

/* ──────────────────────────────────────────────────────────
   Local state
   ────────────────────────────────────────────────────────── */
let editId        = null;
let lectures      = [];        
let currentPage   = 1;
let totalPages    = 1;
let totalCount    = 0;
let isLoading     = false;
let customStartDate = null;
let customEndDate = null;
let selectedLectures = new Set(); // Track selected lecture IDs
const PER_PAGE    = 50;        

/* ──────────────────────────────────────────────────────────
   Dropdown cascade data
   ────────────────────────────────────────────────────────── */
const DD = {
  batches : {
    'D.Pharm':['D- Batch D.Pharm','E- Batch D.Pharm','F- Batch D.Pharm'],
    'B.Pharm':['24-25 B.Pharm','25-26 B.Pharm'],
    'GNM'    :['E- Batch Gnm','F- Batch Gnm']
  },
  years : {
    'D.Pharm':['1st Year','2nd Year'],
    'B.Pharm':['sem 1','sem 2','sem 3','sem 4','sem 5','sem 6','sem 7','sem 8'],
    'GNM'    :['1st Year','2nd Year','3rd Year']
  },
  subjects: {
    'D.Pharm': {
      '1st Year': [
        'Pharmaceutics',
        'Pharmaceutical Chemistry',
        'Pharmacognosy',
        'Human Anatomy & Physiology',
        'Social Pharmacy',
        'Holiday'
      ],
      '2nd Year': [
        'Pharmacology',
        'Pharmacotherapeutics',
        'Biochemistry & Clinical Pathology',
        'Community Pharmacy & Management',
        'Hospital & Clinical Pharmacy',
        'Pharmacy Law & Ethics',
        'Holiday'
      ]
    },
    'B.Pharm': {
      'sem 1': [
        'Human Anatomy and Physiology I (BP101T)',
        'Pharmaceutical Analysis I (BP102T)',
        'Pharmaceutics I (BP103T)',
        'Pharmaceutical Inorganic Chemistry (BP104T)',
        'Communication Skills (BP105T)',
        'Remedial Biology (BP106RBT)',
        'Remedial Mathematics (BP106RMT)',
        'Holiday'
      ],
      'sem 2': [
        'Human Anatomy and Physiology II (BP201T)',
        'Pharmaceutical Organic Chemistry I (BP202T)',
        'Biochemistry (BP203T)',
        'Pathophysiology (BP204T)',
        'Computer Applications in Pharmacy (BP205T)',
        'Environmental Sciences (BP206T)',
        'Holiday'
      ],
      'sem 3': [
        'Pharmaceutical Organic Chemistry II (BP301T)',
        'Physical Pharmaceutics I (BP302T)',
        'Pharmaceutical Microbiology (BP303T)',
        'Pharmaceutical Engineering (BP304T)',
        'Holiday'
      ],
      'sem 4': [
        'Pharmaceutical Organic Chemistry III (BP401T)',
        'Medicinal Chemistry I (BP402T)',
        'Physical Pharmaceutics II (BP403T)',
        'Pharmacology I (BP404T)',
        'Pharmacognosy & Phytochemistry I (BP405T)',
        'Holiday'
      ],
      'sem 5': [
        'Medicinal Chemistry II (BP501T)',
        'Industrial Pharmacy I (BP502T)',
        'Pharmacology II (BP503T)',
        'Pharmacognosy & Phytochemistry II (BP504T)',
        'Pharmaceutical Jurisprudence (BP505T)',
        'Holiday'
      ],
      'sem 6': [
        'Medicinal Chemistry III (BP601T)',
        'Pharmacology III (BP602T)',
        'Herbal Drug Technology (BP603T)',
        'Biopharmaceutics & Pharmacokinetics (BP604T)',
        'Pharmaceutical Biotechnology (BP605T)',
        'Quality Assurance (BP606T)',
        'Holiday'
      ],
      'sem 7': [
        'Instrumental Methods of Analysis (BP701T)',
        'Industrial Pharmacy II (BP702T)',
        'Pharmacy Practice (BP703T)',
        'Novel Drug Delivery System (BP704T)',
        'Holiday'
      ],
      'sem 8': [
        'Biostatistics & Research Methodology (BP801T)',
        'Social & Preventive Pharmacy (BP802T)',
        'Pharma Marketing Management (BP803ET)',
        'Pharmaceutical Regulatory Science (BP804ET)',
        'Pharmacovigilance (BP805ET)',
        'Holiday'
      ]
    },
    'GNM': {
      '1st Year': [
        'Bio‑Science',
        'Behavioural Science',
        'Foundation of Nursing',
        'Community Health Nursing',
        'Holiday'
      ],
      '2nd Year': [
        'Holiday'
      ],
      '3rd Year': [
        'Holiday'
      ]
    }
  }
};

/* ──────────────────────────────────────────────────────────
   Date Range Picker functionality
   ────────────────────────────────────────────────────────── */
let isSelectingRange = false;
let tempStartDate = null;

// Show/hide custom date range picker
dateFilter.addEventListener('change', function() {
  if (this.value === 'custom') {
    customDateRangeDiv.style.display = 'block';
    if (!customStartDate || !customEndDate) {
      customDateRange.value = '';
      customDateRange.placeholder = 'Click to select date range';
    }
  } else {
    customDateRangeDiv.style.display = 'none';
    customStartDate = null;
    customEndDate = null;
  }
  if (this.value !== 'custom') {
    loadLectures(1); // Reset to page 1 when filter changes
  }
});

// Create date picker functionality
customDateRange.addEventListener('click', function() {
  if (isSelectingRange) return;
  
  // Create overlay
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
  
  // Create calendar container
  const calendarContainer = document.createElement('div');
  calendarContainer.className = 'bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4';
  calendarContainer.innerHTML = `
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Select Date Range</h3>
      <button id="closeDatePicker" class="text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="flex gap-4 mb-4">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
        <input type="date" id="startDatePicker" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
      </div>
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
        <input type="date" id="endDatePicker" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
      </div>
    </div>
    <div class="flex gap-2 justify-end">
      <button id="clearDateRange" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition">Clear</button>
      <button id="applyDateRange" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Apply</button>
    </div>
  `;
  
  overlay.appendChild(calendarContainer);
  document.body.appendChild(overlay);
  
  const startDatePicker = document.getElementById('startDatePicker');
  const endDatePicker = document.getElementById('endDatePicker');
  const applyBtn = document.getElementById('applyDateRange');
  const clearBtn = document.getElementById('clearDateRange');
  const closeBtn = document.getElementById('closeDatePicker');
  
  // Set current values if they exist
  if (customStartDate) startDatePicker.value = customStartDate;
  if (customEndDate) endDatePicker.value = customEndDate;
  
  // Validate date range
  function validateRange() {
    if (startDatePicker.value && endDatePicker.value) {
      if (startDatePicker.value > endDatePicker.value) {
        endDatePicker.value = startDatePicker.value;
      }
    }
  }
  
  startDatePicker.addEventListener('change', function() {
    if (endDatePicker.value && this.value > endDatePicker.value) {
      endDatePicker.value = this.value;
    }
    endDatePicker.min = this.value;
  });
  
  endDatePicker.addEventListener('change', validateRange);
  
  // Apply date range
  applyBtn.addEventListener('click', function() {
    if (startDatePicker.value && endDatePicker.value) {
      customStartDate = startDatePicker.value;
      customEndDate = endDatePicker.value;
      
      const startFormatted = new Date(customStartDate).toLocaleDateString();
      const endFormatted = new Date(customEndDate).toLocaleDateString();
      customDateRange.value = `${startFormatted} - ${endFormatted}`;
      
      loadLectures(1); // Reset to page 1 when applying custom date range
    } else {
      alert('Please select both start and end dates');
      return;
    }
    document.body.removeChild(overlay);
  });
  
  // Clear date range
  clearBtn.addEventListener('click', function() {
    customStartDate = null;
    customEndDate = null;
    customDateRange.value = '';
    customDateRange.placeholder = 'Click to select date range';
    loadLectures(1);
    document.body.removeChild(overlay);
  });
  
  // Close picker
  function closePicker() {
    document.body.removeChild(overlay);
  }
  
  closeBtn.addEventListener('click', closePicker);
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) closePicker();
  });
});

/* ──────────────────────────────────────────────────────────
   Holiday functionality
   ────────────────────────────────────────────────────────── */
function handleHolidayToggle() {
  const isHoliday = holidayCheckbox.checked;
  
  if (isHoliday) {
    // First check if subject dropdown has options
    if (subjectSel.options.length <= 1) { // Only has the default "Select Subject" option
      // Enable the subject dropdown and add Holiday option manually
      subjectSel.disabled = false;
      subjectSel.innerHTML = `
        <option value="">Select Subject</option>
        <option value="Holiday">Holiday</option>
      `;
    }
    
    // Select Holiday
    subjectSel.value = 'Holiday';
    
    // Set faculty to "-"
    facultySel.value = '-';
    


    // Make time fields optional
 startInput.value = '';
    endInput.value = '';

 startInput.removeAttribute('required');
    endInput.removeAttribute('required');
    modeSelect.removeAttribute('required');
    
    // Add placeholder text to indicate they're optional
    startInput.placeholder = 'Optional for holidays';
    endInput.placeholder = 'Optional for holidays';
    
    // Add visual styling to show they're optional
    startInput.style.backgroundColor = '#f9fafb';
    endInput.style.backgroundColor = '#f9fafb';
    modeSelect.style.backgroundColor = '#f9fafb';
  } else {
    // Restore required attributes for normal lectures
    startInput.setAttribute('required', '');
    endInput.setAttribute('required', '');
    modeSelect.setAttribute('required', '');
    
    // Clear holiday-specific selections if they were auto-set
    if (subjectSel.value === 'Holiday') {
      subjectSel.value = '';
    }
    if (facultySel.value === '-') {
      facultySel.value = '';
    }
  // Clear the fields when unchecking holiday
    startInput.value = '';
    endInput.value = '';
    modeSelect.value = '';

    // Remove placeholder text and styling
    startInput.placeholder = '';
    endInput.placeholder = '';
    startInput.style.backgroundColor = '';
    endInput.style.backgroundColor = '';
    modeSelect.style.backgroundColor = '';
    
    // If we manually added Holiday option, restore the proper cascade behavior
    if (courseSel.value && yearSel.value) {
      const list = DD.subjects[courseSel.value]?.[yearSel.value] || [];
      fill(subjectSel, list, 'Select Subject');
    } else {
      reset(subjectSel, 'Select Subject');
    }
  }
}

// Add event listener for holiday checkbox
holidayCheckbox.addEventListener('change', handleHolidayToggle);

/* ──────────────────────────────────────────────────────────
   Cascading dropdown helpers
   ────────────────────────────────────────────────────────── */
const fill = (sel, list, ph='Select')=>{
  sel.innerHTML = `<option value="">${ph}</option>` + list.map(o=>`<option>${o}</option>`).join('');
  sel.disabled  = !list.length;
};
const reset = (sel, ph)=>fill(sel,[],ph);

courseSel.onchange = ()=>{
  const c = courseSel.value;
  fill(batchSel , DD.batches[c]||[], 'Select Batch');
  fill(yearSel  , DD.years[c]  ||[], 'Select Year/Semester');
  reset(subjectSel,'Select Subject');
  
  // If holiday is checked, reapply Holiday selection
  if (holidayCheckbox.checked) {
    handleHolidayToggle();
  }
};
yearSel.onchange = ()=>{
  const list = DD.subjects[courseSel.value]?.[yearSel.value] || [];
  fill(subjectSel,list,'Select Subject');
  
  // If holiday is checked, reapply Holiday selection
  if (holidayCheckbox.checked) {
    handleHolidayToggle();
  }
};

/* ──────────────────────────────────────────────────────────
   Utility helpers
   ────────────────────────────────────────────────────────── */
const todayISO = () => new Date().toISOString().split('T')[0];
const tomorrowISO = () => {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  return tomorrow.toISOString().split('T')[0];
};

const rowClass = d => {
  const today = todayISO();
  const tomorrow = tomorrowISO();
  
  if (d === today) return 'bg-green-50 border-l-4 border-green-500';
  if (d === tomorrow) return 'bg-blue-50 border-l-4 border-blue-500';
  if (d > today) return 'bg-orange-50 border-l-4 border-orange-500';
  return 'bg-gray-50 border-l-4 border-gray-400';
};

// Date helper functions
const getWeekStart = (date) => {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day;
  return new Date(d.setDate(diff));
};

const getWeekEnd = (date) => {
  const weekStart = getWeekStart(date);
  return new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000);
};

/* ──────────────────────────────────────────────────────────
   Bulk selection functionality
   ────────────────────────────────────────────────────────── */
function updateBulkActionsUI() {
  const selectedCount_ = selectedLectures.size;
  
  if (selectedCount_ > 0) {
    bulkActionsBar.style.display = 'flex';
    selectedCount.textContent = `${selectedCount_} lecture${selectedCount_ !== 1 ? 's' : ''} selected`;
  } else {
    bulkActionsBar.style.display = 'none';
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  }
  
  // Update select all checkbox state
  const currentPageIds = lectures.map(l => l.id);
  const selectedOnPage = currentPageIds.filter(id => selectedLectures.has(id)).length;
  
  if (selectedOnPage === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (selectedOnPage === currentPageIds.length) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  }
}

function toggleLectureSelection(lectureId, isChecked) {
  if (isChecked) {
    selectedLectures.add(lectureId);
  } else {
    selectedLectures.delete(lectureId);
  }
  updateBulkActionsUI();
}

function selectAllOnPage() {
  lectures.forEach(lecture => {
    selectedLectures.add(lecture.id);
    const checkbox = document.querySelector(`input[data-lecture-id="${lecture.id}"]`);
    if (checkbox) checkbox.checked = true;
  });
  updateBulkActionsUI();
}

function clearSelection() {
  selectedLectures.clear();
  document.querySelectorAll('.lecture-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  updateBulkActionsUI();
}

async function bulkDeleteLectures() {
  if (selectedLectures.size === 0) return;
  
  const confirmed = confirm(`Are you sure you want to delete ${selectedLectures.size} selected lecture${selectedLectures.size !== 1 ? 's' : ''}? This action cannot be undone.`);
  if (!confirmed) return;
  
  // Show loading state
  const originalText = bulkDeleteBtn.innerHTML;
  bulkDeleteBtn.innerHTML = `
    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
    </svg>
    Deleting...
  `;
  bulkDeleteBtn.disabled = true;
  
  try {
    // Delete all selected lectures
    const deletePromises = Array.from(selectedLectures).map(id => 
      fetch(`/api/lectures/${id}`, { method: 'DELETE' })
    );
    
    await Promise.all(deletePromises);
    
    // Clear selection and reload
    clearSelection();
    loadLectures(currentPage);
    
    // Show success message briefly
    bulkDeleteBtn.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      Deleted!
    `;
    
    setTimeout(() => {
      bulkDeleteBtn.innerHTML = originalText;
      bulkDeleteBtn.disabled = false;
    }, 2000);
    
  } catch (error) {
    console.error('Error deleting lectures:', error);
    alert('Error deleting some lectures. Please try again.');
    bulkDeleteBtn.innerHTML = originalText;
    bulkDeleteBtn.disabled = false;
  }
}

// Bulk action event listeners
selectAllCheckbox.addEventListener('change', function() {
  if (this.checked) {
    selectAllOnPage();
  } else {
    clearSelection();
  }
});

selectAllBtn.addEventListener('click', selectAllOnPage);
clearSelectionBtn.addEventListener('click', clearSelection);
bulkDeleteBtn.addEventListener('click', bulkDeleteLectures);
/*  Group order: today → tomorrow → future → past,
    then sort future ascending, past descending                */
// function sortLects(arr){
//   const t = todayISO();
//   const tm = tomorrowISO();
  
//   return arr.slice().sort((a,b)=>{
//     if (a.date === t && b.date !== t) return -1;
//     if (b.date === t && a.date !== t) return  1;
    
//     if (a.date === tm && b.date !== tm && b.date !== t) return -1;
//     if (b.date === tm && a.date !== tm && a.date !== t) return  1;

//     if (a.date > t && b.date > t)   return new Date(a.date) - new Date(b.date); 
//     if (a.date < t && b.date < t)   return new Date(b.date) - new Date(a.date); 

//     return a.date > t ? -1 : 1;  
//   });
// }

function sortLects(arr){
  // Server now handles sorting, so just return the array as-is
  return arr;
}

/* ──────────────────────────────────────────────────────────
   Build API-query URL with filters and pagination
   ────────────────────────────────────────────────────────── */
function buildUrl(page = 1) {
  const params = new URLSearchParams({
    limit: PER_PAGE,
    page: page
  });

  // Add filters to API call
  if (dateFilter.value !== 'all') {
    if (dateFilter.value === 'custom' && customStartDate && customEndDate) {
      params.append('startDate', customStartDate);
      params.append('endDate', customEndDate);
    } else {
      params.append('dateFilter', dateFilter.value);
    }
  }

  if (courseFilter.value !== 'all') {
    params.append('course', courseFilter.value);
  }

  if (branchFilter.value !== 'all') {
    params.append('branch', branchFilter.value);
  }

  if (facultyFilter.value !== 'all') {
    params.append('faculty', facultyFilter.value);
  }

  if (modeFilter.value !== 'all') {
    params.append('mode', modeFilter.value);
  }

  const url = '/api/lectures?' + params.toString();
  console.log('API URL:', url); // Debug log
  return url;
}

/* ──────────────────────────────────────────────────────────
   Data loader with pagination
   ────────────────────────────────────────────────────────── */
async function loadLectures(page = 1) {
  if (isLoading) return;

  isLoading = true;
  spinner.style.display = 'inline';

  try {
    const response = await fetch(buildUrl(page));
    if (!response.ok) {
      throw new Error('Failed to fetch lectures');
    }

    const data = await response.json();
    console.log('Server response:', data); // Debug log
    
    lectures = data.lectures || [];
    currentPage = page;
    
    // Handle totalCount - only update if provided (first page) or preserve existing
    if (data.totalCount !== undefined && data.totalCount !== null) {
      totalCount = data.totalCount;
    } else if (page === 1) {
      // If first page and no totalCount, count current results
      totalCount = lectures.length;
    }
    // For other pages, keep existing totalCount
    
    totalPages = Math.ceil(totalCount / PER_PAGE);
    
    console.log(`Page: ${page}, Total: ${totalCount}, Pages: ${totalPages}`); // Debug log

    // Clear selection when changing pages/filters
    selectedLectures.clear();
    updateBulkActionsUI();

    updatePaginationUI();
    updateFilterUI();
    render();

  } catch (error) {
    console.error('Error loading lectures:', error);
    tbody.innerHTML = `<tr><td colspan="13" class="py-8 text-center text-red-500">Error loading lectures. Please try again.</td></tr>`;
  } finally {
    isLoading = false;
    spinner.style.display = 'none';
  }
}

/* ──────────────────────────────────────────────────────────
   Pagination UI helpers
   ────────────────────────────────────────────────────────── */
function updatePaginationUI() {
  // Update pagination info
  const startItem = totalCount === 0 ? 0 : (currentPage - 1) * PER_PAGE + 1;
  const endItem = Math.min(currentPage * PER_PAGE, totalCount);
  paginationInfo.textContent = `Showing ${startItem} to ${endItem} of ${totalCount} results`;

  // Update button states
  firstPageBtn.disabled = currentPage === 1;
  prevPageBtn.disabled = currentPage === 1;
  nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
  lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;

  // Generate page numbers
  generatePageNumbers();
}

function generatePageNumbers() {
  pageNumbers.innerHTML = '';
  
  if (totalPages <= 1) return;

  const maxVisiblePages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

  // Adjust start page if we're near the end
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }

  // Add ellipsis and first page if needed
  if (startPage > 1) {
    addPageButton(1);
    if (startPage > 2) {
      const ellipsis = document.createElement('span');
      ellipsis.textContent = '...';
      ellipsis.className = 'px-2 py-1 text-sm text-gray-500';
      pageNumbers.appendChild(ellipsis);
    }
  }

  // Add page number buttons
  for (let i = startPage; i <= endPage; i++) {
    addPageButton(i);
  }

  // Add ellipsis and last page if needed
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const ellipsis = document.createElement('span');
      ellipsis.textContent = '...';
      ellipsis.className = 'px-2 py-1 text-sm text-gray-500';
      pageNumbers.appendChild(ellipsis);
    }
    addPageButton(totalPages);
  }
}

function addPageButton(pageNum) {
  const button = document.createElement('button');
  button.textContent = pageNum;
  button.className = currentPage === pageNum 
    ? 'px-3 py-1 text-sm bg-indigo-600 text-white rounded-md'
    : 'px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50';
  
  button.addEventListener('click', () => {
    if (pageNum !== currentPage) {
      loadLectures(pageNum);
    }
  });
  
  pageNumbers.appendChild(button);
}

/* ──────────────────────────────────────────────────────────
   Pagination event handlers
   ────────────────────────────────────────────────────────── */
firstPageBtn.addEventListener('click', () => loadLectures(1));
prevPageBtn.addEventListener('click', () => loadLectures(Math.max(1, currentPage - 1)));
nextPageBtn.addEventListener('click', () => loadLectures(Math.min(totalPages, currentPage + 1)));
lastPageBtn.addEventListener('click', () => loadLectures(totalPages));

/* ──────────────────────────────────────────────────────────
   Filter functions
   ────────────────────────────────────────────────────────── */
function updateFilterUI() {
  // Update result count
  resultCount.textContent = `${totalCount} result${totalCount !== 1 ? 's' : ''}`;
  
  // Update active filters display
  const activeFiltersList = [];
  const filterLabels = {
    dateFilter: 'Date',
    courseFilter: 'Course', 
    branchFilter: 'Branch',
    facultyFilter: 'Faculty',
    modeFilter: 'Mode'
  };
  
  Object.entries(filterLabels).forEach(([filterId, label]) => {
    const filterEl = document.getElementById(filterId);
    if (filterEl.value !== 'all') {
      activeFiltersList.push({
        id: filterId,
        label: label,
        value: filterEl.options[filterEl.selectedIndex].text
      });
    }
  });
  
  if (activeFiltersList.length > 0) {
    activeFilters.style.display = 'block';
    filterTags.innerHTML = activeFiltersList.map(filter => `
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
        ${filter.label}: ${filter.value}
        <button onclick="clearFilter('${filter.id}')" class="ml-1 hover:text-indigo-600">×</button>
      </span>
    `).join('');
  } else {
    activeFilters.style.display = 'none';
  }
}

window.clearFilter = (filterId) => {
  document.getElementById(filterId).value = 'all';
  loadLectures(1); // Reset to page 1 when clearing filter
};

function clearAllFilters() {
  dateFilter.value = 'all';
  courseFilter.value = 'all';
  branchFilter.value = 'all';
  facultyFilter.value = 'all';
  modeFilter.value = 'all';
  customStartDate = null;
  customEndDate = null;
  customDateRange.value = '';
  customDateRangeDiv.style.display = 'none';
  loadLectures(1); // Reset to page 1 when clearing all filters
}

/* ──────────────────────────────────────────────────────────
   Download functionality - downloads all matching results
   ────────────────────────────────────────────────────────── */
async function downloadCSV() {
  if (totalCount === 0) {
    alert('No lectures to download. Please adjust your filters or add some lectures.');
    return;
  }

 // Show loading state
  const originalText = downloadBtn.innerHTML;
  downloadBtn.innerHTML = `
    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
    </svg>
    Loading...
  `;
  downloadBtn.disabled = true;

  try {
    // Fetch all pages for download
    let allLectures = [];
    let page = 1;
    let hasMore = true;

    while (hasMore) {
      const url = buildUrl(page).replace(`limit=${PER_PAGE}`, 'limit=1000'); // Larger chunks for download
      const response = await fetch(url);
      const data = await response.json();
      
      allLectures.push(...(data.lectures || []));
      hasMore = data.lectures && data.lectures.length === 1000;
      page++;
    }

    // Define CSV headers
    const headers = [
      'Course', 'Batch', 'Branch', 'Year', 'Subject', 'Faculty', 
      'Date', 'Start Time', 'End Time', 'Mode', 'Link', 'Location'
    ];

    // Convert lectures to CSV format - REMOVED sortLects() call
    const csvContent = [
      headers.join(','), // Header row
      ...allLectures.map(lecture => [
        `"${lecture.course || ''}"`,
        `"${lecture.batch || ''}"`,
        `"${lecture.branch || ''}"`,
        `"${lecture.year || ''}"`,
        `"${lecture.subject || ''}"`,
        `"${lecture.faculty || ''}"`,
        `"${lecture.date || ''}"`,
        `"${lecture.start || ''}"`,
        `"${lecture.end || ''}"`,
        `"${lecture.mode || ''}"`,
        `"${lecture.link || ''}"`,
        `"${lecture.location || ''}"`
      ].join(','))
    ].join('\n');

    // Create and download the file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      
      // Generate filename with current date and filter info
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
      
      // Add filter info to filename
      let filterInfo = '';
      const activeFiltersList = [];
      
      if (dateFilter.value !== 'all') activeFiltersList.push(dateFilter.value);
      if (courseFilter.value !== 'all') activeFiltersList.push(courseFilter.value);
      if (branchFilter.value !== 'all') activeFiltersList.push(branchFilter.value);
      if (facultyFilter.value !== 'all') activeFiltersList.push(facultyFilter.options[facultyFilter.selectedIndex].text.replace(/[^a-zA-Z0-9]/g, ''));
      if (modeFilter.value !== 'all') activeFiltersList.push(modeFilter.value);
      
      if (activeFiltersList.length > 0) {
        filterInfo = '_' + activeFiltersList.join('_');
      }
      
      const filename = `lectures_${dateStr}_${timeStr}${filterInfo}.csv`;
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Show success message
      downloadBtn.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        Downloaded!
      `;
      
      setTimeout(() => {
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }, 2000);
    }
  } catch (error) {
    console.error('Error downloading CSV:', error);
    alert('Error downloading CSV. Please try again.');
    downloadBtn.innerHTML = originalText;
    downloadBtn.disabled = false;
  }
}
/* ──────────────────────────────────────────────────────────
   Rendering
   ────────────────────────────────────────────────────────── */
function render(){
  const today = todayISO();
  const tomorrow = tomorrowISO();
  
  // REMOVED sortLects() call - lectures come pre-sorted from server
  const html = lectures.map(l=>`
    <tr class="hover:bg-slate-50 ${rowClass(l.date)}">
      <td class="px-4 py-3">
        <input type="checkbox" class="lecture-checkbox h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" 
               data-lecture-id="${l.id}" ${selectedLectures.has(l.id) ? 'checked' : ''}>
      </td>
      <td class="px-4 py-3">${l.course}</td>
      <td class="px-4 py-3">${l.batch}</td>
      <td class="px-4 py-3">${l.branch||''}</td>
      <td class="px-4 py-3">${l.year}</td>
      <td class="px-4 py-3">${l.subject}</td>
      <td class="px-4 py-3">${l.faculty}</td>
      <td class="px-4 py-3">
        <span class="font-medium">${l.date}</span>
        ${l.date===today?'<span class="ml-1 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">Today</span>':''}
        ${l.date===tomorrow?'<span class="ml-1 px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full">Tomorrow</span>':''}
      </td>
      <td class="px-4 py-3">${l.start}</td>
      <td class="px-4 py-3">${l.end}</td>
      <td class="px-4 py-3">
        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${String(l.mode).toLowerCase()==='online'?'bg-blue-100 text-blue-800':'bg-purple-100 text-purple-800'}">
          ${l.mode||'N/A'}
        </span>
      </td>
      <td class="px-4 py-3">${l.link?`<a href="${l.link}" target="_blank" class="text-indigo-600">🔗</a>`:''}</td>
      <td class="px-4 py-3">${l.location||''}</td>
      <td class="px-4 py-3">
        <button onclick="editLecture('${l.id}')"   class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 mr-1">Edit</button>
        <button onclick="deleteLecture('${l.id}')" class="px-3 py-1 bg-red-500  text-white text-xs rounded hover:bg-red-600">Delete</button>
      </td>
    </tr>`).join('');

  tbody.innerHTML = html || `<tr><td colspan="14" class="py-8 text-center text-slate-500">No lectures found matching your filters</td></tr>`;
  
  // Add event listeners to checkboxes
  document.querySelectorAll('.lecture-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      toggleLectureSelection(this.dataset.lectureId, this.checked);
    });
  });
  
  // Update bulk actions UI after rendering
  updateBulkActionsUI();
}

/* ──────────────────────────────────────────────────────────
   CRUD helpers
   ────────────────────────────────────────────────────────── */
window.deleteLecture = async id=>{
  if (!confirm('Delete lecture?')) return;
  await fetch(`/api/lectures/${id}`,{method:'DELETE'});
  loadLectures(currentPage); // Reload current page
};

window.editLecture = async id=>{
  const r = await fetch(`/api/lectures/${id}`);
  if(!r.ok) return alert('Lecture not found');
  const lec = await r.json();

  // Check if it's a holiday entry
  if (lec.subject === 'Holiday') {
    holidayCheckbox.checked = true;
    handleHolidayToggle(); // Apply holiday field modifications
  } else {
    holidayCheckbox.checked = false;
    handleHolidayToggle(); // Ensure normal lecture requirements
  }

  courseSel.value = lec.course||''; courseSel.dispatchEvent(new Event('change'));
  setTimeout(()=>{
    batchSel.value = lec.batch||'';
    yearSel.value  = lec.year ||''; yearSel.dispatchEvent(new Event('change'));
    setTimeout(()=>{ subjectSel.value = lec.subject||''; },20);
  },20);

  ['branch','date','start','end','mode','link','location','faculty']
    .forEach(f=> form[f] && (form[f].value = lec[f]||''));

  editId = id;
  formTitle.textContent = 'Edit Lecture';
  submitBtn.textContent = 'Update';
  form.scrollIntoView({behavior:'smooth'});
};

form.addEventListener('submit',async e=>{
  e.preventDefault();
  const body = JSON.stringify(Object.fromEntries(new FormData(form)));
  const url  = editId ? `/api/lectures/${editId}` : '/api/lectures';
  const res  = await fetch(url,{method: editId?'PUT':'POST',
                                headers:{'Content-Type':'application/json'}, body});
  if(!res.ok) return alert('Save failed');

  resetForm(); 
  loadLectures(currentPage); // Reload current page after save
});

function resetForm(){
  form.reset(); editId=null;
  formTitle.textContent='Add Lecture'; submitBtn.textContent='Save';
  reset(batchSel ,'Select Batch');
  reset(yearSel  ,'Select Year/Semester');
  reset(subjectSel,'Select Subject');
  
  // Reset holiday checkbox and restore required fields
  holidayCheckbox.checked = false;
  startInput.setAttribute('required', '');
  endInput.setAttribute('required', '');
  modeSelect.setAttribute('required', '');
}
cancelBtn.onclick = resetForm;

/* ──────────────────────────────────────────────────────────
   Filter handling - reset to page 1 when filters change
   ────────────────────────────────────────────────────────── */
[courseFilter, branchFilter, facultyFilter, modeFilter].forEach(sel=>{
  sel.onchange = () => loadLectures(1); // Reset to page 1 when filter changes
});

clearFiltersBtn.onclick = clearAllFilters;
downloadBtn.onclick = downloadCSV;

/* ──────────────────────────────────────────────────────────
   Kick-off
   ────────────────────────────────────────────────────────── */
loadLectures(1);
</script>



</body>
</html>