<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lectures CRUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <nav class="bg-white shadow sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <span class="text-xl font-bold text-indigo-600">Dashboard</span>
                <div class="space-x-2 sm:space-x-4 text-sm font-medium">
                    <a href="/"            class="hover:text-indigo-600 transition">Home</a>
                    <a href="lectures.html"  class="text-indigo-600">Lectures</a>
                    <a href="students.html"  class="hover:text-indigo-600 transition">Students</a>
                    <a href="announcements.html" class="hover:text-indigo-600 transition">Announcements</a>
                    <a href="banners.html" class="hover:text-indigo-600 transition">Banners</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section id="formSection" class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 id="formTitle" class="text-xl font-semibold mb-4">Add Lecture</h2>
            <form id="form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <select name="course" id="courseSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Course</option>
                    <option value="D.Pharm">D.Pharm</option>
                    <option value="B.Pharm">B.Pharm</option>
                    <option value="GNM">GNM</option>
                </select>
                
                <select name="batch" id="batchSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Batch</option>
                </select>
                
                <select name="branch" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Branch</option>
                    <option value="Nalasopara">Nalasopara</option>
                    <option value="Bhayandar">Bhayandar</option>
                    <option value="Malad">Malad</option>
                    <option value="Thane">Thane</option>
                    <option value="Andheri">Andheri</option>
                    <option value="Kurla">Kurla</option>
                </select>
                
                <select name="year" id="yearSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Year/Semester</option>
                </select>
                
                <select name="subject" id="subjectSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Subject</option>
                </select>
                
                <select name="faculty" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Faculty</option>
                    <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
                    <option value="Rubina Khan mam">Rubina Khan mam</option>
                    <option value="Abhishekh Prajapati Sir">Abhishekh Prajapati Sir</option>
                    <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
                    <option value="Akashdeep Udmale Sir">Akashdeep Udmale Sir</option>
                    <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
                    <option value="Priya Vijay Gholap mam">Priya Vijay Gholap mam</option>
                    <option value="Amit Agrawal sir">Amit Agrawal sir</option>
                    <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
                    <option value="Deepika Gill mam">Deepika Gill mam</option>
                    <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
                    <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
                    <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
                    <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
                    <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
                    <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
                    <option value="Rajesh sir">Rajesh sir</option>
                    <option value="Ravish Sir">Ravish Sir</option>
                    <option value="ajay">ajay</option>
                    <option value="Naresh Basude">Naresh Basude</option>
                    <option value="Zara Mam">Zara Mam</option>
                    <option value="Suryansh Sir">Suryansh Sir</option>
                    <option value="Sneha durge mam">Sneha durge mam</option>
                    <option value="Dr Utpala mam">Dr Utpala mam</option>
                </select>
                
                <input  name="date"      type="date"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="start"     type="time"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="end"       type="time"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                
                <select name="mode" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Mode</option>
                    <option value="Online">Online</option>
                    <option value="Offline">Offline</option>
                </select>
                
                <input  name="link"      placeholder="Link (opt)"          class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="location"  placeholder="Location (opt)"    class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">

                <div class="sm:col-span-2 lg:col-span-3 flex gap-2">
                    <button type="submit" id="submitBtn"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition">
                        Save
                    </button>
                    <button type="button" id="cancelBtn"
                            class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Filter Lectures</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <select id="dateFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Dates</option>
                    <option value="today">Today's Lectures</option>
                    <option value="previous">Previous Lectures</option>
                    <option value="upcoming">Upcoming Lectures</option>
                </select>
                <select id="courseFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Courses</option>
                    <option value="D.Pharm">D.Pharm</option>
                    <option value="B.Pharm">B.Pharm</option>
                    <option value="GNM">GNM</option>
                </select>
                <select id="facultyFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Faculty</option>
                    <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
                    <option value="Rubina Khan mam">Rubina Khan mam</option>
                    <option value="Abhishekh Prajapati Sir">Abhishekh Prajapati Sir</option>
                    <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
                    <option value="Akashdeep Udmale Sir">Akashdeep Udmale Sir</option>
                    <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
                    <option value="Priya Vijay Gholap mam">Priya Vijay Gholap mam</option>
                    <option value="Amit Agrawal sir">Amit Agrawal sir</option>
                    <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
                    <option value="Deepika Gill mam">Deepika Gill mam</option>
                    <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
                    <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
                    <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
                    <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
                    <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
                    <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
                    <option value="Rajesh sir">Rajesh sir</option>
                    <option value="Ravish Sir">Ravish Sir</option>
                    <option value="ajay">ajay</option>
                    <option value="Naresh Basude">Naresh Basude</option>
                    <option value="Zara Mam">Zara Mam</option>
                    <option value="Suryansh Sir">Suryansh Sir</option>
                    <option value="Sneha durge mam">Sneha durge mam</option>
                    <option value="Dr Utpala mam">Dr Utpala mam</option>
                </select>
                <select id="modeFilter" class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">All Modes</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                </select>
            </div>
            <div class="mt-4 flex flex-wrap gap-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    Today's Lectures
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                    <div class="w-2 h-2 bg-orange-500 rounded-full mr-2"></div>
                    Upcoming Lectures
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                    Previous Lectures
                </span>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow overflow-x-auto">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Lectures</h3>
                    <div class="flex gap-2">
                        <button id="loadMoreBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition" style="display: none;">Load More</button>
                        <span id="loadingIndicator" class="text-sm text-gray-500" style="display: none;">Loading...</span>
                    </div>
                </div>
            </div>
            <table id="list" class="w-full text-sm text-left">
                <thead class="bg-slate-100 text-slate-700 uppercase tracking-wider">
                    <tr>
                        <th class="px-4 py-3">Course</th><th class="px-4 py-3">Batch</th><th class="px-4 py-3">Branch</th>
                        <th class="px-4 py-3">Year</th><th class="px-4 py-3">Subject</th><th class="px-4 py-3">Faculty</th>
                        <th class="px-4 py-3">Date</th><th class="px-4 py-3">Start</th><th class="px-4 py-3">End</th>
                        <th class="px-4 py-3">Mode</th><th class="px-4 py-3">Link</th><th class="px-4 py-3">Location</th>
                        <th class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100" id="listBody">
                </tbody>
            </table>
        </section>
    </main>

    <script>
        const form          = document.getElementById('form');
        const list          = document.getElementById('list');
        const formTitle     = document.getElementById('formTitle');
        const submitBtn     = document.getElementById('submitBtn');
        const cancelBtn     = document.getElementById('cancelBtn');
        const loadMoreBtn   = document.getElementById('loadMoreBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // Filter elements
        const dateFilter = document.getElementById('dateFilter');
        const courseFilter = document.getElementById('courseFilter');
        const facultyFilter = document.getElementById('facultyFilter');
        const modeFilter = document.getElementById('modeFilter');
        
        // Form dropdown elements
        const courseSelect = document.getElementById('courseSelect');
        const batchSelect = document.getElementById('batchSelect');
        const yearSelect = document.getElementById('yearSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        
        let editId = null;
        let allLectures = [];
        let lastVisible = null;
        let hasMore = false;
        let isLoading = false;

        // Dropdown data structure
        const dropdownData = {
            batches: {
                'D.Pharm': ['D- Batch D.Pharm', 'E- Batch D.Pharm', 'F- Batch D.Pharm'],
                'B.Pharm': ['24-25 B.Pharm', '25-26 B.Pharm'],
                'GNM': ['E- Batch Gnm', 'F- Batch Gnm']
            },
            years: {
                'D.Pharm': ['1st Year', '2nd Year'],
                'B.Pharm': ['sem 1', 'sem 2', 'sem 3', 'sem 4', 'sem 5', 'sem 6', 'sem 7', 'sem 8'],
                'GNM': ['1st Year', '2nd Year', '3rd Year']
            },
            subjects: {
                'D.Pharm': {
                    '1st Year': ['Pharmaceutics', 'Pharmaceutical Chemistry', 'Pharmacognosy', 'Human Anatomy & Physiology', 'Social Pharmacy'],
                    '2nd Year': ['Pharmacology', 'Pharmacotherapeutics', 'Biochemistry & Clinical Pathology', 'Community Pharmacy & Management', 'Hospital & Clinical Pharmacy', 'Pharmacy Law & Ethics']
                },
                'B.Pharm': {
                    'sem 1': ['Human Anatomy and Physiology I (BP101T)', 'Pharmaceutical Analysis I (BP102T)', 'Pharmaceutics I (BP103T)', 'Pharmaceutical Inorganic Chemistry (BP104T)', 'Communication Skills* (BP105T)', 'Remedial Biology* / Remedial Mathematics* (BP106RBT / BP106RMT)'],
                    'sem 2': ['Human Anatomy and Physiology II (BP201T)', 'Pharmaceutical Organic Chemistry I (BP202T)', 'Biochemistry (BP203T)', 'Pathophysiology (BP204T)', 'Computer Applications in Pharmacy* (BP205T)', 'Environmental Sciences* (BP206T)'],
                    'sem 3': ['Pharmaceutical Organic Chemistry II (BP301T)', 'Physical Pharmaceutics I (BP302T)', 'Pharmaceutical Microbiology (BP303T)', 'Pharmaceutical Engineering (BP304T)'],
                    'sem 4': ['Pharmaceutical Organic Chemistry III (BP401T)', 'Medicinal Chemistry I (BP402T)', 'Physical Pharmaceutics II (BP403T)', 'Pharmacology I (BP404T)', 'Pharmacognosy and Phytochemistry I (BP405T)'],
                    'sem 5': ['Medicinal Chemistry II (BP501T)', 'Industrial Pharmacy I (BP502T)', 'Pharmacology II (BP503T)', 'Pharmacognosy and Phytochemistry II (BP504T)', 'Pharmaceutical Jurisprudence (BP505T)'],
                    'sem 6': ['Medicinal Chemistry III (BP601T)', 'Pharmacology III (BP602T)', 'Herbal Drug Technology (BP603T)', 'Biopharmaceutics and Pharmacokinetics (BP604T)', 'Pharmaceutical Biotechnology (BP605T)', 'Quality Assurance (BP606T)'],
                    'sem 7': ['Instrumental Methods of Analysis (BP701T)', 'Industrial Pharmacy II (BP702T)', 'Pharmacy Practice (BP703T)', 'Novel Drug Delivery System (BP704T)'],
                    'sem 8': ['Biostatistics and Research Methodology (BP801T)', 'Social and Preventive Pharmacy (BP802T)', 'Pharma Marketing Management (BP803ET)', 'Pharmaceutical Regulatory Science (BP804ET)', 'Pharmacovigilance (BP805ET)']
                },
                'GNM': {
                    '1st Year': ['Bio- Science', 'Behavioural Science', 'Foundation of nursing', 'Community Health Nurssing'],
                    '2nd Year': ['Bio- Science', 'Behavioural Science', 'Foundation of nursing', 'Community Health Nurssing'],
                    '3rd Year': ['Bio- Science', 'Behavioural Science', 'Foundation of nursing', 'Community Health Nurssing']
                }
            }
        };

        // Dropdown cascade functions
        function populateDropdown(selectElement, options, placeholder = 'Select Option') {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            options.forEach(option => {
                selectElement.innerHTML += `<option value="${option}">${option}</option>`;
            });
            selectElement.disabled = false;
        }

        function resetDropdown(selectElement, placeholder = 'Select Option') {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            selectElement.disabled = true;
        }

        function handleCourseChange() {
            const selectedCourse = courseSelect.value;
            
            if (selectedCourse) {
                const batches = dropdownData.batches[selectedCourse];
                if (batches) {
                    populateDropdown(batchSelect, batches, 'Select Batch');
                } else {
                    resetDropdown(batchSelect, 'Select Batch');
                }
                
                const years = dropdownData.years[selectedCourse];
                if (years) {
                    populateDropdown(yearSelect, years, 'Select Year/Semester');
                } else {
                    resetDropdown(yearSelect, 'Select Year/Semester');
                }
                
                resetDropdown(subjectSelect, 'Select Subject');
            } else {
                resetDropdown(batchSelect, 'Select Batch');
                resetDropdown(yearSelect, 'Select Year/Semester');
                resetDropdown(subjectSelect, 'Select Subject');
            }
        }

        function handleYearChange() {
            const selectedCourse = courseSelect.value;
            const selectedYear = yearSelect.value;
            
            if (selectedCourse && selectedYear) {
                const subjects = dropdownData.subjects[selectedCourse] && dropdownData.subjects[selectedCourse][selectedYear];
                if (subjects) {
                    populateDropdown(subjectSelect, subjects, 'Select Subject');
                } else {
                    resetDropdown(subjectSelect, 'Select Subject');
                }
            } else {
                resetDropdown(subjectSelect, 'Select Subject');
            }
        }

        // Add event listeners for dropdown cascading
        courseSelect.addEventListener('change', handleCourseChange);
        yearSelect.addEventListener('change', handleYearChange);

        // Helper functions
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function getLectureRowClass(lectureDate) {
            const today = getToday();
            if (lectureDate === today) {
                return 'bg-green-50 border-l-4 border-green-500';
            } else if (lectureDate < today) {
                return 'bg-gray-50 border-l-4 border-gray-400';
            } else {
                return 'bg-orange-50 border-l-4 border-orange-500';
            }
        }

        function sortLecturesByDate(lectures) {
            const today = getToday();
            return lectures.sort((a, b) => {
                if (a.date === today && b.date !== today) return -1;
                if (b.date === today && a.date !== today) return 1;
                
                if (a.date > today && b.date > today) {
                    return new Date(a.date) - new Date(b.date);
                }
                
                if (a.date < today && b.date < today) {
                    return new Date(b.date) - new Date(a.date);
                }
                
                if (a.date > today && b.date < today) return -1;
                if (b.date > today && a.date < today) return 1;
                
                return 0;
            });
        }

        function buildApiUrl(isLoadMore = false) {
            const params = new URLSearchParams();
            
            // Add filters
            if (dateFilter.value !== 'all') {
                params.append('dateFilter', dateFilter.value);
            }
            if (courseFilter.value !== 'all') {
                params.append('course', courseFilter.value);
            }
            if (facultyFilter.value !== 'all') {
                params.append('faculty', facultyFilter.value);
            }
            if (modeFilter.value !== 'all') {
                params.append('mode', modeFilter.value);
            }
            
            // Add pagination
            params.append('limit', '30');
            if (isLoadMore && lastVisible) {
                params.append('startAfter', lastVisible);
            }
            
            return '/api/lectures?' + params.toString();
        }

        // Main function to load lectures from API with backend filtering
        async function loadLecturesAndDisplay(isLoadMore = false) {
            if (isLoading) return;
            
            console.log('=== LOAD LECTURES FUNCTION START ===');
            isLoading = true;
            loadingIndicator.style.display = 'inline';
            
            // Sample data for fallback
            const sampleLectures = [
                {
                    id: '1',
                    course: 'D.Pharm',
                    batch: 'D- Batch D.Pharm',
                    branch: 'Nalasopara',
                    year: '1st Year',
                    subject: 'Pharmaceutics',
                    faculty: 'Srishti Rajesh Pohuja mam',
                    date: getToday(),
                    start: '10:00',
                    end: '12:00',
                    mode: 'Online',
                    link: 'https://meet.google.com/abc-123',
                    location: ''
                },
                {
                    id: '2',
                    course: 'B.Pharm',
                    batch: '24-25 B.Pharm',
                    branch: 'Bhayandar',
                    year: 'sem 2',
                    subject: 'Pharmaceutical Organic Chemistry I (BP202T)',
                    faculty: 'Rubina Khan mam',
                    date: new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0],
                    start: '14:00',
                    end: '16:00',
                    mode: 'Offline',
                    link: '',
                    location: 'Room 101'
                },
                {
                    id: '3',
                    course: 'GNM',
                    batch: 'E- Batch Gnm',
                    branch: 'Malad',
                    year: '2nd Year',
                    subject: 'Foundation of nursing',
                    faculty: 'Abhishekh Prajapati Sir',
                    date: new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0],
                    start: '09:00',
                    end: '11:00',
                    mode: 'Online',
                    link: 'https://meet.google.com/xyz-789',
                    location: ''
                }
            ];

            try {
                const response = await fetch(buildApiUrl(isLoadMore));
                if (response.ok) {
                    const data = await response.json();
                    const lectures = data.lectures || [];
                    
                    if (isLoadMore) {
                        // Append to existing lectures
                        allLectures = [...allLectures, ...lectures];
                    } else {
                        // Replace lectures
                        allLectures = lectures.length > 0 ? lectures : sampleLectures;
                    }
                    
                    lastVisible = data.lastVisible;
                    hasMore = data.hasMore;
                    
                    console.log('Loaded lectures from API:', lectures.length);
                    console.log('Total lectures:', allLectures.length);
                    console.log('Has more:', hasMore);
                } else {
                    const errorText = await response.text();
                    console.error(`Failed to load lectures from API: ${response.status} - ${errorText}`);
                    if (!isLoadMore) {
                        allLectures = sampleLectures;
                        alert('Failed to load lectures from the server. Using sample data. Please try again later.');
                    }
                }
            } catch (error) {
                console.error('Network error during API load:', error);
                if (!isLoadMore) {
                    allLectures = sampleLectures;
                    alert('Could not connect to the server to load lectures. Using sample data. Please check your network connection.');
                }
            }

            isLoading = false;
            loadingIndicator.style.display = 'none';
            
            // Update UI
            displayLectures(allLectures);
            updateLoadMoreButton();
            
            console.log('=== LOAD LECTURES FUNCTION END ===');
        }

        function displayLectures(lectures) {
            const sortedLectures = sortLecturesByDate(lectures);
            const tbody = document.getElementById('listBody');
            
            tbody.innerHTML = sortedLectures.length
                ? sortedLectures.map(l => `
                    <tr class="hover:bg-slate-50 ${getLectureRowClass(l.date)}">
                        <td class="px-4 py-3">${l.course}</td>
                        <td class="px-4 py-3">${l.batch}</td>
                        <td class="px-4 py-3">${l.branch}</td>
                        <td class="px-4 py-3">${l.year}</td>
                        <td class="px-4 py-3">${l.subject}</td>
                        <td class="px-4 py-3">${l.faculty}</td>
                        <td class="px-4 py-3">
                            <span class="font-medium">${l.date}</span>
                            ${l.date === getToday() ? '<span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Today</span>' : ''}
                        </td>
                        <td class="px-4 py-3">${l.start}</td>
                        <td class="px-4 py-3">${l.end}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${(l.mode || '').toLowerCase() === 'online' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">
                                ${l.mode || 'N/A'}
                            </span>
                        </td>
                        <td class="px-4 py-3">${l.link ? `<a href="${l.link}" target="_blank" class="text-indigo-600 hover:text-indigo-800">🔗</a>` : ''}</td>
                        <td class="px-4 py-3">${l.location || ''}</td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2">
                                <button onclick="editLecture('${l.id}')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition">Edit</button>
                                <button onclick="deleteLecture('${l.id}')" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition">Delete</button>
                            </div>
                        </td>
                    </tr>`).join('')
                : `<tr><td colspan="13" class="text-center py-8 text-slate-500">No lectures found. ${dateFilter.value !== 'all' ? 'Try changing the filter or ' : ''}Add one above!</td></tr>`;
        }

        function updateLoadMoreButton() {
            if (hasMore && !isLoading) {
                loadMoreBtn.style.display = 'inline-block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        function resetForm() {
            form.reset(); 
            editId = null;
            formTitle.textContent = 'Add Lecture';
            submitBtn.textContent = 'Save';
            
            resetDropdown(batchSelect, 'Select Batch');
            resetDropdown(yearSelect, 'Select Year/Semester');
            resetDropdown(subjectSelect, 'Select Subject');
        }

        cancelBtn.addEventListener('click', resetForm);

        // Function to edit a lecture
        window.editLecture = async function(id) {
            let lecture;
            try {
                const response = await fetch(`/api/lectures/${id}`);
                if (response.ok) {
                    lecture = await response.json();
                } else {
                    const errorText = await response.text();
                    console.error(`Failed to fetch lecture for edit: ${response.status} - ${errorText}`);
                    alert('Failed to retrieve lecture details for editing. Please check server connection.');
                    return;
                }
            } catch (error) {
                console.error('Network error fetching lecture for edit:', error);
                alert('Could not connect to the server to retrieve lecture details for editing. Please check your network.');
                return;
            }

            if (lecture) {
                // Set course first to trigger cascading
                courseSelect.value = lecture.course || '';
                handleCourseChange();

                setTimeout(() => {
                    batchSelect.value = lecture.batch || '';
                    yearSelect.value = lecture.year || '';

                    handleYearChange();

                    setTimeout(() => {
                        subjectSelect.value = lecture.subject || '';

                        // Set all other form fields
                        Object.keys(lecture).forEach(k => {
                            if (form[k] && !['course', 'batch', 'year', 'subject'].includes(k)) {
                                form[k].value = lecture[k];
                            }
                        });
                    }, 50);
                }, 50);

                editId = id;
                formTitle.textContent = 'Edit Lecture';
                submitBtn.textContent = 'Update';
                document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Lecture not found for editing. It might have been deleted or an error occurred.');
            }
        };

        // Function to delete a lecture
        window.deleteLecture = async function(id) {
            if (!confirm('Delete lecture?')) return;
            console.log('Attempting to delete lecture with ID:', id);

            try {
                const response = await fetch(`/api/lectures/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    console.log('✅ Lecture deleted successfully from database.');
                    alert('Lecture deleted successfully!');
                } else {
                    const errorText = await response.text();
                    console.error(`❌ API delete failed with status: ${response.status} - ${errorText}`);
                    alert('Failed to delete lecture from the server. Please check console for details.');
                }
            } catch (error) {
                console.error('❌ Network error during delete operation:', error);
                alert('Could not connect to the server to delete lecture. Please check your network connection.');
            }

            // Reset pagination and reload
            resetPagination();
            loadLecturesAndDisplay();
        };

        // Form submission handler
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form));

            try {
                const method = editId ? 'PUT' : 'POST';
                const url = editId ? `/api/lectures/${editId}` : '/api/lectures';
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert(`Lecture ${editId ? 'updated' : 'added'} successfully!`);
                } else {
                    const errorText = await response.text();
                    console.error(`API submission failed: ${response.status} - ${errorText}`);
                    alert(`Failed to save lecture to the database. ${errorText || ''}. Please check console for details.`);
                }
            } catch (error) {
                console.error('Network error during API submission:', error);
                alert('Could not connect to the server to save lecture. Please check your network connection and ensure the API is running.');
            }

            resetForm();
            // Reset pagination and reload
            resetPagination();
            loadLecturesAndDisplay();
        });

        // Reset pagination state
        function resetPagination() {
            lastVisible = null;
            hasMore = false;
            allLectures = [];
        }

        // Filter change handlers
        function handleFilterChange() {
            resetPagination();
            loadLecturesAndDisplay();
        }

        // Load more button handler
        loadMoreBtn.addEventListener('click', () => {
            loadLecturesAndDisplay(true);
        });

        // Add event listeners for filters
        dateFilter.addEventListener('change', handleFilterChange);
        courseFilter.addEventListener('change', handleFilterChange);
        facultyFilter.addEventListener('change', handleFilterChange);
        modeFilter.addEventListener('change', handleFilterChange);

        // Initialize page
        loadLecturesAndDisplay();
    </script>
</body>
</html>