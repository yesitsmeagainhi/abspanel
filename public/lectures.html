<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lectures CRUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <nav class="bg-white shadow sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <span class="text-xl font-bold text-indigo-600">Dashboard</span>
                <div class="space-x-2 sm:space-x-4 text-sm font-medium">
                    <a href="/"            class="hover:text-indigo-600 transition">Home</a>
                    <a href="lectures.html"  class="text-indigo-600">Lectures</a>
                    <a href="students.html"  class="hover:text-indigo-600 transition">Students</a>
                    <a href="announcements.html" class="hover:text-indigo-600 transition">Announcements</a>
                    <a href="banners.html" class="hover:text-indigo-600 transition">Banners</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section id="formSection" class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 id="formTitle" class="text-xl font-semibold mb-4">Add Lecture</h2>
            <form id="form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <select name="course" id="courseSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Course</option>
                    <option value="D.Pharm">D.Pharm</option>
                    <option value="B.Pharm">B.Pharm</option>
                    <option value="GNM">GNM</option>
                </select>
                
                <select name="batch" id="batchSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Batch</option>
                </select>
                
                <select name="branch" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Branch</option>
                    <option value="Nalasopara">Nalasopara</option>
                    <option value="Bhayandar">Bhayandar</option>
                    <option value="Malad">Malad</option>
                    <option value="Thane">Thane</option>
                    <option value="Andheri">Andheri</option>
                    <option value="Kurla">Kurla</option>
                </select>
                
                <select name="year" id="yearSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Year/Semester</option>
                </select>
                
                <select name="subject" id="subjectSelect" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                    <option value="">Select Subject</option>
                </select>
                
                <select name="faculty" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Faculty</option>
                     <option value="-">-</option>
        <option value="ajay">ajay</option>
        <option value="Amit Agrawal sir">Amit Agrawal sir</option>
        <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
        <option value="Deepika Gill mam">Deepika Gill mam</option>
        <option value="Dr. Akashdeep Udmale Sir">Dr. Akashdeep Udmale Sir</option>
        <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
        <option value="Dr. Snehal Chavhan mam">Dr. Snehal Chavhan mam</option>
        <option value="Dr Utpala mam">Dr Utpala mam</option>
        <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
        <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
        <option value="Mr. Abhishek prajapati">Mr. Abhishek prajapati</option>
        <option value="Naresh Basude">Naresh Basude</option>
        <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
        <option value="Priya mayur dighe mam">Priya mayur dighe mam</option>
        <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
        <option value="Rajesh Prajapat">Rajesh Prajapat</option>
        <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
        <option value="Ravish Verma Sir">Ravish Verma Sir</option>
        <option value="Rubina Khan mam">Rubina Khan mam</option>
        <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
        <option value="Sharda Burande mam">Sharda Burande mam</option>
        <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
        <option value="Sneha durge mam">Sneha durge mam</option>
        <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
        <option value="Suryansh Singh">Suryansh Singh</option>
        <option value="Zara Mam">Zara Mam</option>
                </select>
                
                <input  name="date"      type="date"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="start"     type="time"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="end"       type="time"              required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                
                <select name="mode" required class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Select Mode</option>
                    <option value="Online">Online</option>
                    <option value="Offline">Offline</option>
                </select>
                
                <input  name="link"      placeholder="Link (opt)"          class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input  name="location"  placeholder="Location (opt)"    class="border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">

                <div class="sm:col-span-2 lg:col-span-3 flex gap-2">
                    <button type="submit" id="submitBtn"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition">
                        Save
                    </button>
                    <button type="button" id="cancelBtn"
                            class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white rounded-xl shadow p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                <h2 class="text-xl font-semibold">Filter Lectures</h2>
                <div class="flex gap-2 items-center flex-wrap">
                    <button id="downloadBtn" class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download CSV
                    </button>
                    <button id="clearFiltersBtn" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition">
                        Clear All
                    </button>
                    <span id="resultCount" class="text-sm text-gray-600 font-medium"></span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-4">
                <div>
                    <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <select id="dateFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Dates</option>
                        <option value="today">Today's Lectures</option>
                        <option value="previous">Previous Lectures</option>
                        <option value="upcoming">Upcoming Lectures</option>
                        <option value="this_week">This Week</option>
                        <option value="next_week">Next Week</option>
                    </select>
                </div>
                
                <div>
                    <label for="courseFilter" class="block text-sm font-medium text-gray-700 mb-1">Course</label>
                    <select id="courseFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Courses</option>
                        <option value="D.Pharm">D.Pharm</option>
                        <option value="B.Pharm">B.Pharm</option>
                        <option value="GNM">GNM</option>
                    </select>
                </div>
                
                <div>
                    <label for="branchFilter" class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
                    <select id="branchFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Branches</option>
                        <option value="Nalasopara">Nalasopara</option>
                        <option value="Bhayandar">Bhayandar</option>
                        <option value="Malad">Malad</option>
                        <option value="Thane">Thane</option>
                        <option value="Andheri">Andheri</option>
                        <option value="Kurla">Kurla</option>
                    </select>
                </div>
                
               <div>
    <label for="facultyFilter" class="block text-sm font-medium text-gray-700 mb-1">Faculty</label>
    <select id="facultyFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
        <option value="all">All Faculty</option>
        <option value="-">-</option>
        <option value="ajay">ajay</option>
        <option value="Amit Agrawal sir">Amit Agrawal sir</option>
        <option value="Ankit Khedekar Sir">Ankit Khedekar Sir</option>
        <option value="Deepika Gill mam">Deepika Gill mam</option>
        <option value="Dr. Akashdeep Udmale Sir">Dr. Akashdeep Udmale Sir</option>
        <option value="Dr. Ruhi Solkar mam">Dr. Ruhi Solkar mam</option>
        <option value="Dr. Snehal Chavhan mam">Dr. Snehal Chavhan mam</option>
        <option value="Dr Utpala mam">Dr Utpala mam</option>
        <option value="Jitesh Choudhary sir">Jitesh Choudhary sir</option>
        <option value="Kuldeep Prajapati sir">Kuldeep Prajapati sir</option>
        <option value="Mr. Abhishek prajapati">Mr. Abhishek prajapati</option>
        <option value="Naresh Basude">Naresh Basude</option>
        <option value="Pooja Ghuge mam">Pooja Ghuge mam</option>
        <option value="Priya mayur dighe mam">Priya mayur dighe mam</option>
        <option value="Rachana Chauhan mam">Rachana Chauhan mam</option>
        <option value="Rajesh Prajapat">Rajesh Prajapat</option>
        <option value="Rashmi Ghuge mam">Rashmi Ghuge mam</option>
        <option value="Ravish Verma Sir">Ravish Verma Sir</option>
        <option value="Rubina Khan mam">Rubina Khan mam</option>
        <option value="Shalaka Regan Fernandes mam">Shalaka Regan Fernandes mam</option>
        <option value="Sharda Burande mam">Sharda Burande mam</option>
        <option value="Shraddha Agrawal mam">Shraddha Agrawal mam</option>
        <option value="Sneha durge mam">Sneha durge mam</option>
        <option value="Srishti Rajesh Pohuja mam">Srishti Rajesh Pohuja mam</option>
        <option value="Suryansh Singh">Suryansh Singh</option>
        <option value="Zara Mam">Zara Mam</option>
    </select>
</div>
                
                <div>
                    <label for="modeFilter" class="block text-sm font-medium text-gray-700 mb-1">Mode</label>
                    <select id="modeFilter" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">All Modes</option>
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div id="activeFilters" class="mb-4" style="display: none;">
                <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-sm font-medium text-gray-700">Active filters:</span>
                    <div id="filterTags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    Today's Lectures
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                    <div class="w-2 h-2 bg-orange-500 rounded-full mr-2"></div>
                    Upcoming Lectures  
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                    Previous Lectures
                </span>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow overflow-x-auto">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Lectures</h3>
                    <div class="flex gap-2">
                        <button id="loadMoreBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition" style="display: none;">Load More</button>
                        <span id="loadingIndicator" class="text-sm text-gray-500" style="display: none;">Loading...</span>
                    </div>
                </div>
            </div>
            <table id="list" class="w-full text-sm text-left">
                <thead class="bg-slate-100 text-slate-700 uppercase tracking-wider">
                    <tr>
                        <th class="px-4 py-3">Course</th><th class="px-4 py-3">Batch</th><th class="px-4 py-3">Branch</th>
                        <th class="px-4 py-3">Year</th><th class="px-4 py-3">Subject</th><th class="px-4 py-3">Faculty</th>
                        <th class="px-4 py-3">Date</th><th class="px-4 py-3">Start</th><th class="px-4 py-3">End</th>
                        <th class="px-4 py-3">Mode</th><th class="px-4 py-3">Link</th><th class="px-4 py-3">Location</th>
                        <th class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100" id="listBody">
                </tbody>
            </table>
        </section>
    </main>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DOM references
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const form         = document.getElementById('form');
const formTitle    = document.getElementById('formTitle');
const submitBtn    = document.getElementById('submitBtn');
const cancelBtn    = document.getElementById('cancelBtn');

const loadMoreBtn  = document.getElementById('loadMoreBtn');   
const spinner      = document.getElementById('loadingIndicator');

const dateFilter   = document.getElementById('dateFilter');
const courseFilter = document.getElementById('courseFilter');
const branchFilter = document.getElementById('branchFilter');
const facultyFilter= document.getElementById('facultyFilter');
const modeFilter   = document.getElementById('modeFilter');
const clearFiltersBtn = document.getElementById('clearFiltersBtn');
const downloadBtn  = document.getElementById('downloadBtn');
const resultCount  = document.getElementById('resultCount');
const activeFilters = document.getElementById('activeFilters');
const filterTags   = document.getElementById('filterTags');

const courseSel    = document.getElementById('courseSelect');
const batchSel     = document.getElementById('batchSelect');
const yearSel      = document.getElementById('yearSelect');
const subjectSel   = document.getElementById('subjectSelect');
const tbody        = document.getElementById('listBody');

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Local state
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let editId        = null;
let lectures      = [];        
let allLectures   = [];        // Store all fetched lectures for client-side filtering
let cursor        = null;      
let hasMore       = false;
let isLoading     = false;
const PER_PAGE    = 30;        

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Dropdown cascade data
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DD = {
  batches : {
    'D.Pharm':['D- Batch D.Pharm','E- Batch D.Pharm','F- Batch D.Pharm'],
    'B.Pharm':['24-25 B.Pharm','25-26 B.Pharm'],
    'GNM'    :['E- Batch Gnm','F- Batch Gnm']
  },
  years : {
    'D.Pharm':['1st Year','2nd Year'],
    'B.Pharm':['sem 1','sem 2','sem 3','sem 4','sem 5','sem 6','sem 7','sem 8'],
    'GNM'    :['1st Year','2nd Year','3rd Year']
  },
  subjects : {
    'D.Pharm':{ }, 'B.Pharm':{ }, 'GNM':{ }
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Cascading dropdown helpers
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const fill = (sel, list, ph='Select')=>{
  sel.innerHTML = `<option value="">${ph}</option>` + list.map(o=>`<option>${o}</option>`).join('');
  sel.disabled  = !list.length;
};
const reset = (sel, ph)=>fill(sel,[],ph);

courseSel.onchange = ()=>{
  const c = courseSel.value;
  fill(batchSel , DD.batches[c]||[], 'Select Batch');
  fill(yearSel  , DD.years[c]  ||[], 'Select Year/Semester');
  reset(subjectSel,'Select Subject');
};
yearSel.onchange = ()=>{
  const list = DD.subjects[courseSel.value]?.[yearSel.value] || [];
  fill(subjectSel,list,'Select Subject');
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Utility helpers
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const todayISO = () => new Date().toISOString().split('T')[0];

const rowClass = d =>
  d === todayISO() ? 'bg-green-50 border-l-4 border-green-500'
: d  > todayISO() ? 'bg-orange-50 border-l-4 border-orange-500'
                  : 'bg-gray-50  border-l-4 border-gray-400';

// Date helper functions
const getWeekStart = (date) => {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day;
  return new Date(d.setDate(diff));
};

const getWeekEnd = (date) => {
  const weekStart = getWeekStart(date);
  return new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000);
};

const isDateInRange = (lectureDate, filter) => {
  const today = new Date(todayISO());
  const lecDate = new Date(lectureDate);
  
  switch(filter) {
    case 'today':
      return lectureDate === todayISO();
    case 'previous':
      return lecDate < today;
    case 'upcoming':
      return lecDate > today;
    case 'this_week':
      const thisWeekStart = getWeekStart(today);
      const thisWeekEnd = getWeekEnd(today);
      return lecDate >= thisWeekStart && lecDate <= thisWeekEnd;
    case 'next_week':
      const nextWeekStart = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
      const nextWeekStartWeek = getWeekStart(nextWeekStart);
      const nextWeekEnd = getWeekEnd(nextWeekStart);
      return lecDate >= nextWeekStartWeek && lecDate <= nextWeekEnd;
    default:
      return true;
  }
};

/*  Group order: today â†’ future â†’ past,
    then sort future ascending, past descending                */
function sortLects(arr){
  const t = todayISO();
  return arr.slice().sort((a,b)=>{
    if (a.date === t && b.date !== t) return -1;
    if (b.date === t && a.date !== t) return  1;

    if (a.date > t && b.date > t)   return new Date(a.date) - new Date(b.date); 
    if (a.date < t && b.date < t)   return new Date(b.date) - new Date(a.date); 

    return a.date > t ? -1 : 1;  
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Filter functions
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function applyFilters() {
  let filtered = allLectures.slice();
  
  // Apply date filter
  if (dateFilter.value !== 'all') {
    filtered = filtered.filter(lecture => isDateInRange(lecture.date, dateFilter.value));
  }
  
  // Apply course filter
  if (courseFilter.value !== 'all') {
    filtered = filtered.filter(lecture => lecture.course === courseFilter.value);
  }
  
  // Apply branch filter
  if (branchFilter.value !== 'all') {
    filtered = filtered.filter(lecture => lecture.branch === branchFilter.value);
  }
  
  // Apply faculty filter
  if (facultyFilter.value !== 'all') {
    filtered = filtered.filter(lecture => lecture.faculty === facultyFilter.value);
  }
  
  // Apply mode filter
  if (modeFilter.value !== 'all') {
    filtered = filtered.filter(lecture => lecture.mode === modeFilter.value);
  }
  
  lectures = filtered;
  updateFilterUI();
  render();
}

function updateFilterUI() {
  // Update result count
  resultCount.textContent = `${lectures.length} result${lectures.length !== 1 ? 's' : ''}`;
  
  // Update active filters display
  const activeFiltersList = [];
  const filterLabels = {
    dateFilter: 'Date',
    courseFilter: 'Course', 
    branchFilter: 'Branch',
    facultyFilter: 'Faculty',
    modeFilter: 'Mode'
  };
  
  Object.entries(filterLabels).forEach(([filterId, label]) => {
    const filterEl = document.getElementById(filterId);
    if (filterEl.value !== 'all') {
      activeFiltersList.push({
        id: filterId,
        label: label,
        value: filterEl.options[filterEl.selectedIndex].text
      });
    }
  });
  
  if (activeFiltersList.length > 0) {
    activeFilters.style.display = 'block';
    filterTags.innerHTML = activeFiltersList.map(filter => `
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
        ${filter.label}: ${filter.value}
        <button onclick="clearFilter('${filter.id}')" class="ml-1 hover:text-indigo-600">Ã—</button>
      </span>
    `).join('');
  } else {
    activeFilters.style.display = 'none';
  }
}

window.clearFilter = (filterId) => {
  document.getElementById(filterId).value = 'all';
  applyFilters();
};

function clearAllFilters() {
  dateFilter.value = 'all';
  courseFilter.value = 'all';
  branchFilter.value = 'all';
  facultyFilter.value = 'all';
  modeFilter.value = 'all';
  applyFilters();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Download functionality
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function downloadCSV() {
  if (lectures.length === 0) {
    alert('No lectures to download. Please adjust your filters or add some lectures.');
    return;
  }

  // Define CSV headers
  const headers = [
    'Course', 'Batch', 'Branch', 'Year', 'Subject', 'Faculty', 
    'Date', 'Start Time', 'End Time', 'Mode', 'Link', 'Location'
  ];

  // Convert lectures to CSV format
  const csvContent = [
    headers.join(','), // Header row
    ...sortLects(lectures).map(lecture => [
      `"${lecture.course || ''}"`,
      `"${lecture.batch || ''}"`,
      `"${lecture.branch || ''}"`,
      `"${lecture.year || ''}"`,
      `"${lecture.subject || ''}"`,
      `"${lecture.faculty || ''}"`,
      `"${lecture.date || ''}"`,
      `"${lecture.start || ''}"`,
      `"${lecture.end || ''}"`,
      `"${lecture.mode || ''}"`,
      `"${lecture.link || ''}"`,
      `"${lecture.location || ''}"`
    ].join(','))
  ].join('\n');

  // Create and download the file
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    
    // Generate filename with current date and filter info
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
    
    // Add filter info to filename
    let filterInfo = '';
    const activeFiltersList = [];
    
    if (dateFilter.value !== 'all') activeFiltersList.push(dateFilter.value);
    if (courseFilter.value !== 'all') activeFiltersList.push(courseFilter.value);
    if (branchFilter.value !== 'all') activeFiltersList.push(branchFilter.value);
    if (facultyFilter.value !== 'all') activeFiltersList.push(facultyFilter.options[facultyFilter.selectedIndex].text.replace(/[^a-zA-Z0-9]/g, ''));
    if (modeFilter.value !== 'all') activeFiltersList.push(modeFilter.value);
    
    if (activeFiltersList.length > 0) {
      filterInfo = '_' + activeFiltersList.join('_');
    }
    
    const filename = `lectures_${dateStr}_${timeStr}${filterInfo}.csv`;
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      Downloaded!
    `;
    downloadBtn.disabled = true;
    
    setTimeout(() => {
      downloadBtn.innerHTML = originalText;
      downloadBtn.disabled = false;
    }, 2000);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Build API-query URL (simplified since we're doing client-side filtering)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildUrl(){
  const p = new URLSearchParams({ limit: PER_PAGE });
  if (cursor) p.append('startAfterId', cursor);
  return '/api/lectures?' + p.toString();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Data loader â€“ pulls all pages and stores in allLectures
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchAllLectures(){
  isLoading = true; 
  spinner.style.display = 'inline';
  allLectures = []; 
  lectures = [];
  cursor = null; 
  hasMore = true;

  while (hasMore){                 
    const res = await fetch(buildUrl());
    if (!res.ok){ 
      console.error(await res.text()); 
      break; 
    }

    const { lectures:rows = [], lastVisible, hasMore:more } = await res.json();
    allLectures.push(...rows);
    cursor  = lastVisible;
    hasMore = more;
    if (!hasMore) break;           
  }

  isLoading = false; 
  spinner.style.display = 'none';
  applyFilters(); // Apply current filters to the fetched data
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Rendering
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function render(){
  const html = sortLects(lectures).map(l=>`
    <tr class="hover:bg-slate-50 ${rowClass(l.date)}">
      <td class="px-4 py-3">${l.course}</td>
      <td class="px-4 py-3">${l.batch}</td>
      <td class="px-4 py-3">${l.branch||''}</td>
      <td class="px-4 py-3">${l.year}</td>
      <td class="px-4 py-3">${l.subject}</td>
      <td class="px-4 py-3">${l.faculty}</td>
      <td class="px-4 py-3">
        <span class="font-medium">${l.date}</span>
        ${l.date===todayISO()?'<span class="ml-1 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">Today</span>':''}
      </td>
      <td class="px-4 py-3">${l.start}</td>
      <td class="px-4 py-3">${l.end}</td>
      <td class="px-4 py-3">
        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${String(l.mode).toLowerCase()==='online'?'bg-blue-100 text-blue-800':'bg-purple-100 text-purple-800'}">
          ${l.mode||'N/A'}
        </span>
      </td>
      <td class="px-4 py-3">${l.link?`<a href="${l.link}" target="_blank" class="text-indigo-600">ðŸ”—</a>`:''}</td>
      <td class="px-4 py-3">${l.location||''}</td>
      <td class="px-4 py-3">
        <button onclick="editLecture('${l.id}')"   class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 mr-1">Edit</button>
        <button onclick="deleteLecture('${l.id}')" class="px-3 py-1 bg-red-500  text-white text-xs rounded hover:bg-red-600">Delete</button>
      </td>
    </tr>`).join('');

  tbody.innerHTML = html || `<tr><td colspan="13" class="py-8 text-center text-slate-500">No lectures found matching your filters</td></tr>`;
  loadMoreBtn.style.display = 'none';   
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CRUD helpers
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.deleteLecture = async id=>{
  if (!confirm('Delete lecture?')) return;
  await fetch(`/api/lectures/${id}`,{method:'DELETE'});
  allLectures = allLectures.filter(l=>l.id!==id);
  applyFilters();
};

window.editLecture = async id=>{
  const r = await fetch(`/api/lectures/${id}`);
  if(!r.ok) return alert('Lecture not found');
  const lec = await r.json();

  courseSel.value = lec.course||''; courseSel.dispatchEvent(new Event('change'));
  setTimeout(()=>{
    batchSel.value = lec.batch||'';
    yearSel.value  = lec.year ||''; yearSel.dispatchEvent(new Event('change'));
    setTimeout(()=>{ subjectSel.value = lec.subject||''; },20);
  },20);

  ['branch','date','start','end','mode','link','location','faculty']
    .forEach(f=> form[f] && (form[f].value = lec[f]||''));

  editId = id;
  formTitle.textContent = 'Edit Lecture';
  submitBtn.textContent = 'Update';
  form.scrollIntoView({behavior:'smooth'});
};

form.addEventListener('submit',async e=>{
  e.preventDefault();
  const body = JSON.stringify(Object.fromEntries(new FormData(form)));
  const url  = editId ? `/api/lectures/${editId}` : '/api/lectures';
  const res  = await fetch(url,{method: editId?'PUT':'POST',
                                headers:{'Content-Type':'application/json'}, body});
  if(!res.ok) return alert('Save failed');

  resetForm(); 
  fetchAllLectures(); // Reload all data
});

function resetForm(){
  form.reset(); editId=null;
  formTitle.textContent='Add Lecture'; submitBtn.textContent='Save';
  reset(batchSel ,'Select Batch');
  reset(yearSel  ,'Select Year/Semester');
  reset(subjectSel,'Select Subject');
}
cancelBtn.onclick = resetForm;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Filter handling  (every change â†’ apply client-side filters)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[dateFilter, courseFilter, branchFilter, facultyFilter, modeFilter].forEach(sel=>{
  sel.onchange = applyFilters;
});

clearFiltersBtn.onclick = clearAllFilters;
downloadBtn.onclick = downloadCSV;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Kick-off
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
fetchAllLectures();
</script>

</body>
</html>